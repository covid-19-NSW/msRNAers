<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NSW Covid-19</title>
    <script src="./js/d3.v3.js"></script>
    <script src="./js/d3.v4_2.js"></script>
    <script src="./js/d3.v4.js"></script>
    <!--    <script src="./js/d3.v4.min.js"></script>-->
    <script src="./js/queue.v1.min.js"></script>
    <!--    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>-->

    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <!--    <script src="./dist/dex-jquery.js"></script>-->
    <!--        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
    <!--    <script src="./dist/dex-bootstrap.js"></script>-->
    <script src="./js/underscore-min.js"></script>
    <!--    <script src="./dist/dex-libs.js"></script>-->
    <!--    <script src="./dist/dex.js"></script>-->
    <!--        <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>-->
    <link rel="stylesheet" href="./js/bootstrap.css">
    <link rel="stylesheet" href="./js/style.css">
    <script src="./js/bootstrap.js"></script>
    <!--    <link href="http://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">-->

    <!--    load map-->
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='./js/mapbox-gl.js'></script>
    <link href='./js/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="./css/button.css">
    <script src="./js/d3.v3.min.js"></script>
    <!--    <script src="https://d3js.org/queue.v1.min.js"></script>-->
    <!--    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>-->
    <!--    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>-->
    <!--    <meta name="viewport" content="width=device-width, initial-scale=1">-->
    <!-- Add icon library -->
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="./js/mapbox-gl-geocoder.min.js"></script>
    <link
            rel="stylesheet"
            href="./js/mapbox-gl-geocoder.css"
            type="text/css"
    />
    <link rel="stylesheet" type="text/css" href="./css/style.css" />
    <script src="./js/windowstyle.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/windowstyle.css" />
    <link rel="stylesheet" type="text/css" href="./css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="./css/demo.css">
    <script src = "./js/d3.parcoords.js"></script>
    <script src="./js/divgrid.js"></script>
    <script src="./js/bootstrap.bundle.js"></script>
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <!--    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>-->
    <!--    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>-->
    <!--    load map ends-->


    <style type="text/css">

        /*map style*/
        #map { height: 100%; width:100%;}

        #detailinfo {
            position: absolute;
            background:  #fff;
            padding: 8px;
            bottom: 220px;
            width: 10%;
            left: 10px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            border-radius: 2px;
            line-height: 10.5px
        }

        #menu {
            position: absolute;
            background:  #fff;
            padding: 8px;
            bottom: 330px;
            width: 11%;
            right: 10px;
            font: 13px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            border-radius: 2px;
            line-height: 10.5px
        }

        .legend {
            background-color: #fff;
            border-radius: 3px;
            bottom: 230px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font: 13px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            padding: 8px;
            position: absolute;
            right: 10px;

            width: 11%;
        }

        .legendexample {
            /*background-color: #fff;*/
            border-radius: 3px;
            bottom: 20px;
            /*box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);*/
            /*font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;*/
            padding: 5px;
            /*position: absolute;*/
            right: 10px;
            width: 100%;
        }

        #menu1 {
            position: absolute;
            background:  #fff;
            padding: 10px;
            width: 12% ;
            bottom: 100px ;
            right: 10px;
            /*font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;*/
            /* display: table !important; */
            /* border-radius: 2px;
            line-height: 10.5px */

        }

        #menu2 {

            position: absolute;
            background:  #fff;
            padding: 10px;
            width: 12% ;
            bottom: 145px ;
            right: 10px;
            /*font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;*/

        }

        #menu1 div, #menu2 div {
            display: table-cell;
            text-align: center;
            width: 7%;
            /* position: relative; */
        }

        .btn {
            background-color: rgb(175, 178, 180);
            border: none;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        /*.menu1 label123 {*/
        /*    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;*/
        /*}*/

        .legend h123 {
            float: left;
            font-size: 13px;
            /*margin: 0 0 10px;*/
        }

        .legend div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }
        .legendexample h123 {
            float: left;
            /*margin: 0 0 10px;*/
        }

        .legendexample div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }

        input[type="radio"] + label123 {

            display: inline-block;
            /* width: 15%; */
        }

        .slidecontainer {
            width: 100%;
            /*padding-bottom: 3px*/
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 15px;
            background: rgb(117, 141, 194);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 10px;
            height: 15px;
            background: rgb(117, 141, 194);
            cursor: pointer;
        }

        .mapboxgl-popup {
            max-width: 400px;
            padding: 0px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }

        .slidecontainer > h123  {

            margin-bottom: 3px;
            margin-top: 3px;
            font: 13px 'Helvetica Neue', Arial, Helvetica, sans-serif;

        }

        /* .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right {
            display: none;
        } */


        .mapboxgl-ctrl mapboxgl-ctrl-attrib mapboxgl-compact{
            bottom: 0px;
            padding: 0;
            /* position: absolute; */
            position: initial;
        }

        .mapboxgl-ctrl-attrib.mapboxgl-compact{
            position: initial;
        }
        .mapboxgl-ctrl-geocoder.mapboxgl-ctrl {

            font-size: 12px !important;
        }


        @media (max-width:200px) {

            .mapboxgl-ctrl-geocoder.mapboxgl-ctrl {
                /* right: 10px; */
                border:none;
                box-shadow: none;
                margin-left: 0px;
                width: fit-content;
                height: fit-content;
            }

            .mapboxgl-ctrl-top-right{
                right: 10px;
            }

            /* .mapboxgl-ctrl-geocoder.mapboxgl-ctrl ul li {
                display: none !important;
            } */
            .geocoder {
                right: 10%;
                width: 75%;
                border-right: 1px solid lightgray;
            }
            .geocoder-overlay {
                width: 95%;
            }
            #label123-geocoder {
                display: none;
            }

            .mapboxgl-ctrl-geocoder--pin-right>button{
                display: block !important;
                top: 3px !important;
            }

            .mapboxgl-ctrl-geocoder--input {
                font-size: small !important;
            }


            /*#menu {*/
            /*    !*position: absolute;*!*/
            /*    background:  #fff;*/
            /*    !* padding: 10px; *!*/
            /*    padding-bottom: 10px;*/
            /*    padding-top: 0px;*/
            /*    padding-right: 10px;*/
            /*    bottom: 1000px;*/
            /*    width: 80%;*/
            /*    !* left: 10%; *!*/
            /*    right: 5%;*/
            /*    font-family: 'Open Sans', sans-serif;*/
            /*    border-radius: 2px;*/
            /*    !* line-height: 10.5px; *!*/
            /*    height: 40px;*/
            /*    vertical-align: middle;*/
            /*}*/

            #menu1 {

                bottom: 120px;
                width: 80%;
                /* left: 10%; */
                right: 5%;
            }

            #menu2 {

                bottom: 70px;
                width: 80%;
                /* left: 10%; */
                right: 5%;
            }



            #menu1 div, #menu2 div {
                display: table-cell;
                text-align: center;
                width: 7%;
                /* position: relative; */
            }

            .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right {
                display: none;
            }

            /*.legend{*/

            /*    !*position: absolute;*!*/
            /*    bottom: 170px;*/
            /*    width: fit-content;*/
            /*    right: 5%;*/
            /*}*/
        }

        /*GeoCoder*/
        /*map style ends*/

        *{
            margin: 0;
            padding: 0;
        }
        html,body{
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .main{
            width:100%;
            height: 100%;
            background: #DCDCDC;
            position:absolute;
        }

        .title {
            height: 4%;
            width: 100%;
            float: left;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */
            text-align: center;
            /*border-top:.15em solid #DCDCDC;*/

            /*border-bottom:.15em solid #DCDCDC;*/
            /*border-left:.3em solid #DCDCDC;*/
            /*border-right:.3em solid #DCDCDC;*/
        }


        .content {

            height: 95%;
            width: 100%;
            float: left;
        }
        .graphleft {

            height: 100%;
            width: 68%;
            float: left;
        }
        .graphright {
            height: 100%;
            width: 32%;
            float: left;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:.3em solid #DCDCDC;
            border-bottom:.15em solid #DCDCDC;
            border-left:.15em solid #DCDCDC;
            border-right:.4em solid #DCDCDC;

        }
        .graphleft-top {
            height: 68%;
            width: 100%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:.3em solid #DCDCDC;
            border-bottom:.15em solid #DCDCDC;
            border-left:.4em solid #DCDCDC;
            border-right:.15em solid #DCDCDC;
            float:left;
        }

        .graphleft-bottom{
            height: 32%;
            width: 100%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:.15em solid #DCDCDC;
            border-bottom:.4em solid #DCDCDC;
            border-left:.4em solid #DCDCDC;
            border-right:.15em solid #DCDCDC;
            float:left;
        }

        .graphnewtop{
            height: 77%;
            width: 100%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:.3em solid #DCDCDC;
            border-bottom:.15em solid #DCDCDC;
            border-left:.3em solid #DCDCDC;
            border-right:.3em solid #DCDCDC;
            float:left;
        }
        .graphnewbottom{
            height: 23%;
            width: 100%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:.15em solid #DCDCDC;
            border-bottom:.3em solid #DCDCDC;
            border-left:.3em solid #DCDCDC;
            border-right:.3em solid #DCDCDC;
            float:left;
        }
        .graphnewtopleft{
            height: 100%;
            width: 72%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:0em solid #DCDCDC;
            border-bottom:0em solid #DCDCDC;
            border-left:0em solid #DCDCDC;
            border-right:.15em solid #DCDCDC;
            float:left;
        }
        .graphnewtopright{
            height: 100%;
            width: 28%;
            background: white;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */

            border-top:0em solid #DCDCDC;
            border-bottom:0em solid #DCDCDC;
            border-left:.15em solid #DCDCDC;
            border-right:0em solid #DCDCDC;
            float:left;
        }


        #newflower{
            height: 100%;
            width: 100%;
        }

        #TreemapBarChartParent {
            height: 100% ;
            width: 100%;
        }
        #parallel {
            height: 100%;
            width: 100%;

        }
        #paralleltooltip{
            font-family: sans-serif;
            font-size: 13px;
            font-weight: bold;
            color:black;
        }

        /*body { margin:0; padding:0; }*/
        /*svg {*/
        /*    font: 10px sans-serif;*/
        /*}*/

        .background path {
            fill: none;
            stroke: #efefef;
            shape-rendering: crispEdges;
        }

        .foreground path {
            fill: none;
            /*stroke: steelblue;*/
        }

        .brush .extent {
            fill-opacity: .2;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        .axis line,
        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .axis text {
            text-shadow: 0 3px 0 #FFF, 3px 0 0 #FFF, 0 -3px 0 #FFF, -3px 0 0 #FFF;
            font-size: 12px;
            /*-webkit-text-stroke-width: 10px;*/
            /*-webkit-text-stroke-color: white;*/
            cursor: move;
        }
        .nodetext text {
            text-shadow: 0 3px 0 #FFF, 3px 0 0 #FFF, 0 -3px 0 #FFF, -3px 0 0 #FFF;
            /*-webkit-text-stroke-width: 10px;*/
            /*-webkit-text-stroke-color: white;*/
            cursor: move;
        }

        /*heatmap begins*/
        label123 {
            /*font-family: sans-serif;*/
            /*font-size: 14px;*/
            /*position: absolute;*/
            left: 92px; top: 26px;
        }
        /*.axis .domain { display: none; }*/
        /*.axis line { stroke: #ccc; }*/
        .axis.x0 text {
            font-weight: 9000;
            font-size: 14px;
        }
        .hover-active rect { opacity: .35; }
        .hover-active rect.hover { opacity: 1; }

        .node {
            cursor: pointer;
        }

        .node circle {
            /*stroke: '#f0f';*/
            stroke-width: 4px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .fill_normal {
            fill: green;
        }

        .smallwindow{
            position: absolute;
            text-align: left;
            width: 150px;
            height: 60px;
            background: #444444;
            /*padding: 2vw;*/
            /*font: 1vw sans-serif;*/
            font-size: 1em;
            border: 0px;
            border-radius: 3px;
            color:white;
            /*字体颜色*/
            box-shadow: -3px 3px 15px #888888;
            opacity:0.9;
            display: none;
            padding: 4px;

        }
        .circle{
            border: 1.5px solid red;
        }
        .divinner{
            position: absolute;
            text-align: left;
            width: 180px;
            height: 70px;
            background: #444444;
            /*padding: 2vw;*/
            /*font: 1vw sans-serif;*/
            border: 0px;
            border-radius: 5px;
            color:white;
            /*字体颜色*/
            box-shadow: -3px 3px 15px #888888;
            font-size: 16px;
            opacity:0.8;
            display: none;
            padding: 4px;
        }
        .divinner2{
            position: absolute;
            text-align: left;
            width: 240px;
            height: 70px;
            background: #444444;
            left: 5px;
            top: 5px;
            /*padding: 2vw;*/
            /*font: 1vw sans-serif;*/
            border: 0px;
            border-radius: 5px;
            color:white;
            /*字体颜色*/
            font-size: 16px;
            box-shadow: -3px 3px 15px #888888;
            opacity:0.8;
            display: none;
            padding: 4px;
        }


        .va{vertical-align: top;}

        .divlegend{
            position: absolute;
            text-align: left;
            width: 210px;
            font-size: 14px;
            background: #444444;
            padding: 4px;
            /*padding: 2vw;*/
            /*font: 1vw sans-serif;*/
            border: 0px;
            border-radius: 5px;
            color:white;
            /*字体颜色*/
            box-shadow: -3px 3px 15px #888888;
            opacity:0.8;
            display: none;
        }

        .inline{
            /*display: inline;*/
            font-size: 14px;
            color: white;
        }

        .circle0{
            fill: #FFFFFF;
        }

        .circle0.circlefixed{
            fill: #757575;
        }

        /* 设置下拉按钮的样式 */
        .dropbtn {
            background-color: dimgrey;
            color: white;
            padding: 5px;
            font-size: 10px;
            border: none;
            cursor: pointer;
        }

        /* 容器 <div> - 需要放置下拉内容 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* 下拉内容（默认隐藏） */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        /* 下拉链接 */
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        /* 悬停时更改下拉链接的颜色 */
        .dropdown-content a:hover {background-color: #f1f1f1}

        /* 悬停时显示下拉菜单 */
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* 显示下拉内容时，更改下拉按钮的背景颜色 */
        .dropdown:hover .dropbtn {
            background-color: #3e8e41;
        }


    </style>

</head>
<body>
<div class = "main">
    <div class="title">
        <nav class="navbar" style="height: 100%">
            <a id="userPLink">
                <svg width="18" height="18" fill="white" class="bi bi-patch-exclamation-fill" viewBox="0 0 16 16" >
                    <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01-.622-.636zM8 4c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995A.905.905 0 0 1 8 4zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <span class="va inline">+msRNAer Visual Analytics System </span>

            </a>
        </nav>
    </div>

    <div class="content" id = "content">

        <div class = "graphnewtop" id = "graphnewtop">
            <div class="graphnewtopleft" id="graphleft-graphnewtopleft">
                <div id="newflower">
                    <div id="drag">
                        <div class="divtitle">
                            <h2>Control Panel</h2>
                            <div>
                                <a class="min" href="javascript:;" title="Minimum"></a>
                                <a class="max" href="javascript:;" title="Maximum"></a>
                                <a class="revert" href="javascript:;" title="Revert"></a>
                                <a class="close" href="javascript:;" title="Close"></a>
                            </div>
                        </div>
                        <div class="resizeL"></div>
                        <div class="resizeT"></div>
                        <div class="resizeR"></div>
                        <div class="resizeB"></div>
                        <div class="resizeLT"></div>
                        <div class="resizeTR"></div>
                        <div class="resizeBR"></div>
                        <div class="resizeLB"></div>
                        <!--    <div class="content" id="dragwindow">-->

                        <!--    </div>-->
                        <div class = "content" id="dragwindow" style="height: 50%;width: 100%;" >

                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Datasets:&nbsp;

                                <div class="dropdown">
                                    <button id = "dropbtn" class="dropbtn"> select </button>
                                    <div id = "dropdown-content" class="dropdown-content">
                                        <a href="#" onclick="dropclick1()">Weekly, 2020-2021</a>
                                        <a href="#" onclick="dropclick2()">Fortnightly, 2020-2022</a>
                                    </div>
                                </div>

                            &nbsp;&nbsp;Mode:&nbsp;

                            <div class="dropdown">
                                <button id = "dropbtn2" class="dropbtn"> select </button>
                                <div id = "dropdown-content2" class="dropdown-content">
                                    <a href="#" onclick="dropclick3()">Actual cases</a>
                                    <a href="#" onclick="dropclick4()">Cases per 10k population</a>
                                </div>
                            </div>
                        </div>
                        <div class = "content" id="selectbotton" style="height: 10%;width: 100%; padding-left: 20px; padding-right: 20px; padding-top: 10px;" >
                            <button type="button" class = 'button small' style=" width: 100px; height: 25px; font-size: 14px" onclick="Filterdata()">Filter</button>

                            <button type="button" class = 'button small' style="float:right; width: 100px; height: 25px; font-size: 14px" onclick="Reset()">Reset</button>
                        </div>
                        <div class = "content" id="examplelegend" style="height: 30%;width: 100%" >
                            <div id="LegendExample" class="legendexample">
                                <div style="width: 100%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px">Control Panel: Intervention events & Timeline</div>
                                <br>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #555555"></span>Restrict Control</div>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #7f7f7f"></span>Eased Control</div>

                                <br>

                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #a7a7a7"></span>Uncontrol</div>

                                <br>
                                <div style="width: 100%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px">Main View: Higher Risk Groups & Covid Cases</div>
                                <br>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #d53e4f"></span>Confirmed Case</div>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #C0C0C0"></span>Zero Case</div>
                                <br>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #3288bd"></span>Aged Male</div>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #FFC0CB"></span>Aged Female</div>
                                <br>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #f4d000"></span>Lower Income</div>
                                <div style="width: 50%; float: left; bottom: 5px; font-size: 14px; padding-left: 3px"><span style="background-color: #cab2d6"></span>Lone Person</div>
                                <br>




                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="graphnewtopright" id="graphnewtopright">

                <div id="map"></div>

                <div id='menu'>
                    <!-- <h3>Dates</h3> -->
                    <div class="slidecontainer">
                        <h123>Date: <span id="demo"></span></h123>
                        <!--                        <div id="Datestr"> </div>-->
                        <!--                        <input id="dateSlider" type="range" min="1" class="slider" onchange = "inputbn(this)">-->
                    </div>

                </div>

                <div id="CasesLegend" class="legend">
                    <h123>Color scale by the numbers of confirmed cases</h123>
                    <br>
                    <div style="width: 33%; float: left"><span style="background-color: #FDED22"></span>1-99</div>
                    <div style="width: 33%; float: left"><span style="background-color: #F58320"></span>100-299</div>
                    <div style="width: 33%; float: left"><span style="background-color: #D71F3B"></span>300-499</div>
                    <br>
                    <div style="width: 33%; float: left"><span style="background-color: #781213"></span>500-799</div>
                    <div style="width: 33%; float: left"><span style="background-color: #450C0D"></span>800-1499</div>
                    <div style="width: 33%; float: left"><span style="background-color: #221212"></span>1.5k+</div>
                </div>

            </div>
        </div>

        <div class = "graphnewbottom" id = "graphnewbottom">

            <div id="parallel"></div>

        </div>
    </div>
</div>

<script type="text/javascript">
    // var w = window.innerHeight;
    // var h = window.innerWidth;
    var modestatus = '0';
    var piesymbol;

    var w = document.getElementById("newflower").offsetWidth;    // 返回元素的总宽度
    var h = document.getElementById("newflower").offsetHeight;    // 返回元素的总高度

    var margin = {top: 10, right: 10, bottom: 10, left: 10},
        width = 600 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom,
        radius = 8;
    outradius = 5;

    //var Colorsinepannel = ['#F05964','#FFCF20','#1D4E89','#909987'];
    //var Colorsinepannel = ['#de77ae','#3288bd','#f4d000','#bc80bd'];
    var Colorsinepannel = ['#3288bd','#FFC0CB','#f4d000','#cab2d6']
    //var Colorpannel = ['#F05964','#FFCF20','#1D4E89','#909987'];
    //var Colorsinepannel = ['#fbb4ae','#b3cde3','#ccebc5','#decbe4'];
    var Flowercolorpannel = ['#d53e4f','#1f78b4','#b2df8a','#33a02c','#fb9a99','#a6cee3','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99'];
    //var Flowercolorpannel = ['#d73027','#fc8d59','#fee090','#e0f3f8','#91bfdb','#4575b4'];
    //'#dc3545'
    var ColorGrey = ['#C0C0C0'];
    // var ColorGreyforExample = ['#C0C0C0','#999999','#666666'];
    var ColorGreyforExample = ['#a7a7a7','#7f7f7f','#555555'];
    var ColorBEGrey = ['#BEBEBE'];
    //var ColorGrey = ['#33a02c'];
    var ColorBrown = ["#D2B48C", "#F4A460", "#A0522D","#BC8F8F", "#6E511E","#544742","#305439","#303D3A", "#e88931","#1f78b4"];
    var RedScale = ["#d53e4f", "#af2a37" ,"#8a1622", "#67000d"]
    var RedScale6 = ["#d53e4f",
        "#bf333f",
        "#a92730",
        "#931c21",
        "#7e1014",
        "#690303"];
    var RedScale6turnpink = [
        "#d53e4f",
        "#de525e",
        "#e7646d",
        "#ef767c",
        "#f7878c",
        "#ff989c"
    ];
    var RedScale6redinmiddle = [
        "#FDED22",
        "#F58320",
        "#D71F3B",
        "#781213",
        "#450C0D",
        "#221212"

    ]

    var interventionarr = [];

    var GreyScale = ["#515b62", "#2a2f32"];


    var FlagPieArc = {};

    var focus_node = null, highlight_node = null;

    var text_center = false;
    var outline = false;

    var color = d3.scale.category10();

    var highlight_color = "black";
    var highlight_trans = 0.1;

    var size = d3.scale.pow().exponent(0.5)
        .domain([0.2,100])
        .range([3,30]);

    var force = d3.layout.force()
        // .linkDistance(1)
        .chargeDistance(1500)
        .gravity(0.5)
        .charge(-3000)
        .size([w, h]);

    // Declare Map Variables

    var nswBounds = [
        [140, -38],
        [157, -27]
    ];

    var layerList = document.getElementById('menu1','menu2');
    var inputs = document.getElementsByClassName('radio');


    // var slider = document.getElementById("dateSlider");
    // var output = document.getElementById("demo");

    var defaultDate;
    var defaultDateT;

    var defaultDateR;
    var defaultDateTR;

    var dateSelected;
    var dateSelectedT;
    var Totalcases;

    var dateSelectedR;
    var dateSelectedTR;

    var datearray;
    var dataarrayselected = [];
    var datearrayselected = [];

    // Hide the Tests Legend by Default

    // $('#TestsLegend').css('display','none');

    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
    //mapboxgl.accessToken = 'pk.eyJ1IjoibWFnZTUwMTgiLCJhIjoiY2psd3cwemxuMTlyYzNwb2d4cXhyNGx0ZSJ9.VkkG4riV7oxGcAnStBiHJA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11', // style URL
        //style: 'mapbox://styles/mage5018/ckbumhoti0mes1iqmcl4m1qo7',
        zoom: 8,
        center: [150.91, -33.30],
        pitchWithRotate: false,
        dragRotate: false,
        //maxBounds: nswBounds,
        attributionControl: false
        // hash:true
    });



    //var locationmarknumber = [['Northern China', 5], ['Eastern China', 5], ['Southern China', 3], ['Central China', 3], ['North East', 3], ['North West', 5], ['South West', 5]];
    //var outerpiecolumn = ['Jan','Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
    var outerpiecolumn = [];
    //var locationmarkprovince = ['beijing', 'tianjin', 'hebei', 'shanxi', 'inner mongolia', 'shandong', 'jiangsu', 'anhui', 'jiangxi', 'fujian', 'guangdong', 'guangxi', 'hainan', 'henan', 'hubei', 'hunan', 'heilongjiang', 'jilin', 'liaoning', 'shaanxi', 'gansu', 'ningxia', 'qinghai', 'xinjiang', 'sichuan', 'guizhou', 'yunnan', 'chongqing', 'tibet'];
    var default_node_color = "#ccc";
    //var default_node_color = "rgb(3,190,100)";
    var default_link_color = "#888";
    var nominal_base_node_size = 14;
    var nominal_text_size = 16;
    var max_text_size = 30;
    var nominal_stroke = 1.5;
    var max_stroke = 4.5;
    var max_base_node_size = 30;
    var min_zoom = 0.3;
    var max_zoom = 3.3;
    var svg = d3.select("#newflower").append("svg");
    var legendsvg = d3.select("#dragwindow").append("svg").style("width","100%").style("height","85%");

    var zoom = d3.behavior.zoom().scaleExtent([min_zoom,max_zoom]);
    var g = svg.append("g");
    var lg = legendsvg.append("g");
    //svg.style("cursor","move");

    var tocolor = "fill";
    var towhite = "stroke";
    if (outline) {
        tocolor = "stroke";
        towhite = "fill";
    }
    function descentsort(x,y){
        return y.weekdate - x.weekdate
    }
    var legendtempdata = [];

    function UniqueJson(arr, key) {
        var r = [];
        for (var i = 0, l = arr.length; i < l; i++) {
            for (var j = i + 1; j < l; j++) {
                if (key) {
                    if (arr[i][key] === arr[j][key]) {
                        j = ++i;
                    }
                }
                else {
                    if (arr[i] === arr[j]) {
                        j = ++i;
                    }
                }
            }
            r.push(arr[i]);
        }
        return r;
    }

    function compare(el1, el2, index) {
        //json comparison
        return el1[index] == el2[index] ? 0 : (el1[index] < el2[index] ? -1 : 1);
    }
    function comparearrayfromlargetosmall(a, b){
        return b[2] - a[2];
    }
    //按照第三列排序

    function uniquearr(arr) {
        if (!Array.isArray(arr)) {
            console.log('type error!')
            return
        }
        let res = []
        for (let i = 0; i < arr.length; i++) {
            if (res.indexOf(arr[i]) === -1) {
                res.push(arr[i])
            }
        }
        return res
    }

    function diff(arr1, arr2) {
        var newArr = [];
        var arr3 = [];
        for (var i = 0; i < arr1.length; i++) {
            if (arr2.indexOf(arr1[i]) === -1)
                arr3.push(arr1[i]);
        }
        var arr4 = [];
        for (var j = 0; j < arr2.length; j++) {
            if (arr1.indexOf(arr2[j]) === -1)
                arr4.push(arr2[j]);
        }
        newArr = arr3.concat(arr4);
        return newArr;
    }


    // 去重
    function listRemoveRepeat(x) {
        let result = [];
        for (let i = 0; i < x.length; i++) {
            let flag = true;
            let temp = x[i];
            for (let j = 0; j < result.length; j++) {
                // 普通数组 (temp === result[j])
                if (temp.id === result[j].id) {
                    flag = false;
                    break;
                }
            }
            if (flag) {
                result.push(temp);
            }
        }
        return result;
    }
    // 差集
    function listDifference(x, y) {
        let clone = x.slice(0);
        for (let i = 0; i < y.length; i++) {
            let temp = y[i];
            for (let j = 0; j < clone.length; j++) {
                // 普通数组 (temp === clone[j])
                if (temp.id === clone[j].id) {
                    clone.splice(j, 1);
                }
            }
        }
        return listRemoveRepeat(clone);
    }
    // 并集
    function listConcat(x, y) {
        return listRemoveRepeat(x.concat(y));
    }
    // 交集
    function listIntersection(x, y) {
        let result = [];
        for (let i = 0; i < y.length; i++) {
            let temp = y[i];
            for (let j = 0; j < x.length; j++) {
                // 普通数组 (temp === clone[j])
                if (temp.id === x[j].id) {
                    result.push(temp);
                    break;
                }
            }
        }
        return listRemoveRepeat(result);
    }

    // 交集非0个数
    function listIntersection0(x, y) {
        let result = [];
        for (let i = 0; i < y.length; i++) {
            let temp = y[i];
            for (let j = 0; j < x.length; j++) {
                // 普通数组 (temp === clone[j])
                if ((temp.id === x[j].id) && ((temp.cases != 0 && temp.cases != 300) && (x[j].cases != 0 || x[j].cases != 300))) {
                    result.push(temp);
                    break;
                }
            }
        }
        // var num = listRemoveRepeat(result);
        return result.length;
    }

    //array variables
    var nodeclickedflag4parallel = 0;
    var finaltreemapbararr = [];
    var agelevel = [];
    var incomelevel = [];
    var bedlevel = [];
    var translevel = [];
    var interactedtreemapbardata = [];

    var rankingmalenumber = [];
    var rankingfemalenumber = [];
    var rankingmalepercent = [];
    var rankingfemalepercent = [];
    var rankingpovertynumber = [];
    var rankingpovertypercent = [];
    var rankinglonenumber = [];
    var rankinglonepercent = [];

    var examplepieclickflag = [];
    var exampleclickflag = 0;
    var clickonmapflag = 0;
    var clickcircle0flag = [];
    var clickfilterflag = 0;
    var clickcircle0formap = [];
    var newcircleclick = 0;
    var tempmapdata0 = {};

    var wholedate = "";

    var brushedtogetdata = [];
    var clicktoselectparallel = [];
    var brushtoclickdata = [];
    var brushcondition = [];


    var sumupcases = [];
    var sumupcasesnotstated = [];
    var ranksavingwordsafterselect = [];
    var savinglastsumupcases = [];

    var DictionaryLGAandSuburbs = [];
    var Mapstoredata = [];

    var Mapdatafromstaweektable = [];

    var PCglobal;
    var PSglobal;
    var popglobal;
    var PCglobalforreset;

    //var savingweekdataafterselect = [];

    // var Newmapdata = {
    //     "data":[]
    // };

    var mapclickeddata = [];
    var finaldatafilteringforPC = [];

    var parallelforinteraction = [];
    var parallelforstore = [];


    //parallel coordinates begins
    var paralleldiv = document.getElementById("graphnewbottom");
    var parallelwidth = paralleldiv.clientWidth;    // 返回元素的总宽度
    var parallelheight = paralleldiv.clientHeight;    // 返回元素的总高度

    var dragdiv = document.getElementById("dragwindow");
    var dragwindowwidth = dragdiv.offsetWidth;
    var dragwindowheight = dragdiv.offsetHeight - 30;

    var margin = {top: 30, right: 18, bottom: 10, left: 10},
        width = parallelwidth - margin.left - margin.right,
        height = parallelheight - margin.top - margin.bottom;

    var x = d3.scale.ordinal().rangePoints([0, width], 1),
        y = {},
        dragging = {};

    var line = d3.svg.line().interpolate("cardinal"),
        axis = d3.svg.axis().orient("left"),
        background,
        foreground;

    d3.csv("./datafiles/intervention.csv", function (error, data){
        interventionarr = data;
    })

    d3.csv("./datafiles/Update3-LGA-NSW.csv", function (error, data){
        console.log(data);
        for (var i = 0; i < data.length; i++){
            var templganame = data[i].LGA_Name.split("(")[0].substring(0, data[i].LGA_Name.split("(")[0].length - 1);
            var templgacode = data[i].LGA_code.split("A")[1];
            // if (data[i].lga_code19 != "")
            //     DictionaryLGAandSuburbs.push({
            //         LGAcode: data[i].lga_code19,
            //         POA_NAME16: data[i].postcode,
            //         LGAname: temp
            //     })
            // else{
            //     DictionaryLGAandSuburbs.push({
            //         LGAcode: "Notstated",
            //         POA_NAME16: data[i].postcode,
            //         LGAname: temp
            //     })
            // }
            DictionaryLGAandSuburbs.push({
                "LGAcode": templgacode,
                // POA_NAME16: data[i].postcode,
                "LGAname": templganame
            })
        }
        //d3.json("./Datafiles/lgadata_post_week.json", function(error, data) {
        d3.json("./Datafiles/14_days_Result_v4.json", function(error, data) {

            data.forEach(function(d) {
                //console.log(d);

                Mapdatafromstaweektable.push({
                    "Date": d.Date ,
                    "LGAcode": d.lgacode,
                    "POA_NAME16": d.nsw_lga_3,
                    "Cases": d.cases,
                    "CasesUptonow": 0,
                    "LGAname": d.nsw_lga_3
                })
            });

            // console.log(Mapdatafromstaweektable);
            // console.log(DictionaryLGAandSuburbs);

            for (var j = 0; j < DictionaryLGAandSuburbs.length; j++)
            {
                var tempuptodatetotalbylevel = 0; //next area data
                for (var o = 0; o < Mapdatafromstaweektable.length; o++)
                {


                    //if (DictionaryLGAandSuburbs[j].POA_NAME16.toString() == Mapdatafromstaweektable[o].POA_NAME16)
                    if (DictionaryLGAandSuburbs[j].LGAcode == Mapdatafromstaweektable[o].LGAcode.toString())
                    {
                        //console.log(Mapdatafromstaweektable[o]);
                        var tempuptodatebydate = Mapdatafromstaweektable[o].Cases;
                        tempuptodatetotalbylevel += tempuptodatebydate;
                        Mapdatafromstaweektable[o].CasesUptonow = tempuptodatetotalbylevel;
                        Mapdatafromstaweektable[o].LGAname = DictionaryLGAandSuburbs[j].LGAname;
                    }
                    // if (Mapdatafromstaweektable[o].CasesUptonow != 0)
                    // {
                    //     console.log(tempuptodatetotalbylevel);
                    //
                    // }
                }

            }

            //console.log(Mapdatafromstaweektable);
            // console.log(DictionaryLGAandSuburbs);
        });

        //console.log(Mapdatafromstaweektable);


    })
    //console.log(DictionaryLGAandSuburbs);
    //console.log(Newmapdata);


    d3.csv("./datafiles/20200221-Upate-LGA-NSW.csv", function (error, data) {
        //console.log(data);
        var paralleldata = [];

        var svgparallel = d3.select("#parallel").append("svg")
            // .attr("width", width + margin.left + margin.right)
            .attr("width", parallelwidth)
            .attr("height", parallelheight)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var LGAnamedataarr = [];

        for (var i = 0; i < data.length; i++) {


            LGAnamedataarr.push(String(data[i]["LGA_code"]).substring(3, data[i]["LGA_code"].length));
            paralleldata.push({
                "Median Age": data[i]["MedianAge"],
                "Median Mortgage": data[i]["MedianMortgage"],
                "Median Person Income": data[i]["MedianPersonIncome"],
                "Median Family Income": data[i]["MedianFamilyIncome"],
                "Median Household Income": data[i]["MedianHouseholdIncome"],
                "Median Rent": data[i]["MedianRent"],
                "Average Bedroom": data[i]["AverageBedroom"],
                "Average House Size": data[i]["AverageHouseSize"],
                "Population": data[i]["Population"],
                "Area": data[i]["Area"],
                "Population Density": (Number(data[i]["Male"]) + Number(data[i]["Female"]))/Number(data[i]["Area"]),

                "PublicTrans(%)": data[i]["PercentofPublicTransportation"],
                "LGA_code": Number(String(data[i]["LGA_code"]).substring(3, data[i]["LGA_code"].length)),
                "LGA_Name": data[i]["LGA_Name_abbr"]
            });
            parallelforinteraction.push({
                "Median Age": data[i]["MedianAge"],
                "Median Mortgage": data[i]["MedianMortgage"],
                "Median Person Income": data[i]["MedianPersonIncome"],
                "Median Family Income": data[i]["MedianFamilyIncome"],
                "Median Household Income": data[i]["MedianHouseholdIncome"],
                "Median Rent": data[i]["MedianRent"],
                "Average Bedroom": data[i]["AverageBedroom"],
                "Average House Size": data[i]["AverageHouseSize"],
                "Population": data[i]["Population"],
                "Area": data[i]["Area"],
                "Population Density": (Number(data[i]["Male"]) + Number(data[i]["Female"]))/Number(data[i]["Area"]),

                "PublicTrans(%)": data[i]["PercentofPublicTransportation"],
                "LGA_code": Number(String(data[i]["LGA_code"]).substring(3, data[i]["LGA_code"].length)),
                "LGA_Name": data[i]["LGA_Name_abbr"]

            });
            //console.log(data[i]["LGA_Name"])

        }


        //console.log(paralleldata);
        //console.log(treemapbardata);
        //console.log(LGAnamedataarr);

        // Extract the list of dimensions and create a scale for each.
        x.domain(dimensions = d3.keys(paralleldata[0]).filter(function (d) {
            if(d === "LGA_code") return false;

            if(d === "LGA_Name") {
                y[d] = d3.scale.ordinal()
                    .domain(paralleldata.map(function(p) { return p[d]; }))
                    .rangePoints([height, 0]);

            }
            else {
                y[d] = d3.scale.linear()
                    .domain(d3.extent(paralleldata, function(p) { return +p[d]; }))
                    .range([height, 0]);
            }

            return true;

        }));

        // Add grey background lines for context.
        background = svgparallel.append("g")
            .attr("class", "background")
            .selectAll("path")
            .data(paralleldata)
            .enter().append("path")
            .attr("d", path)
            .attr('id', function (o){
                return "line-" + o.LGAcode;
            });

        // Add blue foreground lines for focus.
        foreground = svgparallel.append("g")
            .attr("class", "foreground")
            .selectAll("path")
            .data(paralleldata)
            .enter().append("path")
            .attr("d", path)
            .attr("id", function (p){
                return 'path-' + p.LGA_code;
            })
            .style("fill", "none")
            .style("stroke", GreyScale[0])
            // .style("stroke", ColorBrown[9])
            .style("stroke-width",1.2)
            .style("opacity", 0.9)
            .on('mouseover', function (p,o) {
                if (nodeclickedflag4parallel == 0){
                    // setTimeout(function () {
                    d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                        .orient('right')
                        .tickValues(paralleldata.map(function(d) {
                            if (d["LGA_Name"] == p["LGA_Name"])
                                return d["LGA_Name"];
                        })));
                    for (var i = 0; i < paralleldata.length; i++)
                    {
                        if (paralleldata[i]["LGA_code"]!= p["LGA_code"])
                        {
                            d3.select("#path-" + paralleldata[i]["LGA_code"])
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }
                    }
                    d3.select("#path-" + p["LGA_code"])
                        .style("opacity", 1)
                        .style("stroke-width",2);
                    // }, 50);


                }



            })
            .on('mouseout', function (p) {
                //console.log(p);
                if (nodeclickedflag4parallel == 0){
                    if (clicktoselectparallel.length == 0)
                    {
                        for (var i = 0; i < paralleldata.length; i++)
                        {
                            d3.select("#path-" + paralleldata[i]["LGA_code"])
                                .style("opacity", 0.9)
                                .style("stroke-width",1.2);

                        }
                    }
                    else{
                        for (var a = 0; a < clicktoselectparallel.length; a++)
                        {
                            for (var j = 0; j < paralleldata.length; j++)
                            {
                                if (clicktoselectparallel[a].LGA_code == paralleldata[j].LGA_code)
                                {
                                    console.log(clicktoselectparallel[a].LGA_code);
                                    d3.select("#path-" + paralleldata[j].LGA_code)
                                        .style("opacity", 1)
                                        .style("stroke-width",2);
                                }
                                else {
                                    d3.select("#path-" + paralleldata[j].LGA_code)
                                        .style("opacity", 0)
                                        .style("stroke-width",0.4);
                                }
                            }
                        }
                    }

                    // d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right').tickValues([]))

                    d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right')
                        .tickValues(clicktoselectparallel.map(function(d) {
                            if (d["LGA_Name"] == p["LGA_Name"]){
                                return d["LGA_Name"];
                            }
                        })))
                }

                //console.log(p["LGA_Name"]);
            })
            .on('click', function (p) {
                //console.log(p["LGA_code"]);
                clicktoselectparallel.push(p);
                d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                    .orient('right')
                    .tickValues(clicktoselectparallel.map(function(d) {
                        // if (d["LGA_Name"] == p["LGA_Name"])
                        return d["LGA_Name"];
                    })));
                // console.log(clicktoselectparallel);
                // console.log(paralleldata);
                for (var i = 0; i < clicktoselectparallel.length; i++)
                {
                    for (var j = 0; j < paralleldata.length; j++)
                    {
                        if (clicktoselectparallel[i].LGA_code == paralleldata[j].LGA_code)
                        {
                            //console.log(clicktoselectparallel[i].LGA_code);
                            d3.select("#path-" + paralleldata[j].LGA_code)
                                .style("opacity", 1)
                                .style("stroke-width",2);
                        }
                        else {
                            d3.select("#path-" + paralleldata[j].LGA_code)
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }


                    }
                }


            })
            .on('dblclick', function (p) {
                console.log(p["LGA_code"]);

                console.log(brushedtogetdata);
            });

        // Add a group element for each dimension.
        var g = svgparallel.selectAll(".dimension")
            .data(dimensions)
            .enter().append("g")
            .attr("class", "dimension")
            .attr("transform", function (d) {
                return "translate(" + x(d) + ")";
            })
            .call(d3.behavior.drag()
                .origin(function (d) {
                    return {x: x(d)};
                })
                .on("dragstart", function (d) {
                    dragging[d] = x(d);
                    background.attr("visibility", "hidden");
                })
                .on("drag", function (d) {
                    dragging[d] = Math.min(width, Math.max(0, d3.event.x));
                    foreground.attr("d", path);
                    dimensions.sort(function (a, b) {
                        return position(a) - position(b);
                    });
                    x.domain(dimensions);
                    g.attr("transform", function (d) {
                        return "translate(" + position(d) + ")";
                    })
                })
                .on("dragend", function (d) {
                    delete dragging[d];
                    transition(d3.select(this)).attr("transform", "translate(" + x(d) + ")");
                    transition(foreground).attr("d", path);
                    background
                        .attr("d", path)
                        .transition()
                        .delay(500)
                        .duration(0)
                        .attr("visibility", null);
                }));

        // Add an axis and title.
        g.append("g")
            .attr("class", "axis")
            .each(function (d,i) {
                if (d != "LGA_Name")
                {
                    //console.log(d);
                    d3.select(this)
                        .attr('id', function() {
                            return 'paxis-' + i;
                        })
                        .call(axis.scale(y[d]));
                }
                else {
                    d3.select(this)
                        .attr('id', function() {
                            return 'paxis-name';
                        })
                        .call(axis.scale(y[d]).orient('right').tickValues([]))
                    //.call(axis.scale(y[d]).orient('right').tickValues(paralleldata.map(function(p) { return p[d]; })).tickFormat(function () { return ''; }))

                }

            })

            .append("text")
            .style("text-anchor", "middle")
            .attr("y", -9)
            .text(function (d) {
                return d;
            })
            .style('font-size', '13px');


        // Add and store a brush for each axis.
        g.append("g")
            .attr("class", "brush")
            .each(function (d) {
                d3.select(this)
                    .call(y[d].brush = d3.svg.brush().y(y[d])
                        .on("brushstart", brushstart)
                        .on("brush", parallelbrush));
            })
            .selectAll("rect")
            .attr("x", -8)
            .attr("width", 16);



        function position(d) {
            var v = dragging[d];
            return v == null ? x(d) : v;
        }

        function transition(g) {
            return g.transition().duration(200);
        }

        // Returns the path for a given data point.
        function path(d) {
            return line(dimensions.map(function(p) { return [position(p), y[p](d[p])]; }));
        }

        function brushstart() {
            d3.event.sourceEvent.stopPropagation();
        }


        //var parallelbrusheddataarr = paralleldata;

        function parallelbrush() {
            d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right').tickValues([]));
            //console.log("brushed");
            brushedtogetdata = [];
            var parallelbrusheddataarr = paralleldata;
            var paralleltemp = [];
            var parallelbrushedcolumn = "";
            var brushedmin, brushedmax;
            var testarr = [];
            var testforfiltering= [];
            var testforlgacode = [];
            var actives = dimensions.filter(function(p) {
                    testarr.push(!y[p].brush.empty());
                    return !y[p].brush.empty();
                }),
                extents = actives.map(function(p) {
                    return y[p].brush.extent();
                });
            foreground.style("display", function(d) {
                // parallelbrushedcolumn.push(d["LGA_Name"]);
                //console.log(d);
                return actives.every(function(p, i, o) {
                    // console.log(o);

                    parallelbrushedcolumn = p;
                    // console.log(p);
                    // console.log(extents[i][0]);
                    // console.log(extents[i][1]);
                    brushedmin = extents[i][0];
                    brushedmax = extents[i][1];
                    // brushcondition.push({
                    //     min: extents[i][0],
                    //     max: extents[i][1]
                    // })
                    // console.log(brushcondition);
                    if (extents[i][0] <= d[p] && d[p] <= extents[i][1])
                    {
                        testforfiltering.push(d);
                        brushedtogetdata.push(d);
                        // var tempstorearrforlga = [];
                        // for (var i = 0; i < brushedtogetdata.length; i ++)
                        // {
                        //     if (d["LGA_Name"] == brushedtogetdata[i].LGA_Name)
                        //     {
                        //         tempstorearrforlga.push(d);
                        //     }
                        // }
                        // brushedtogetdata = tempstorearrforlga;
                    }
                    return extents[i][0] <= d[p] && d[p] <= extents[i][1];
                }) ? null : "none";
            });

            for (var i = 0; i < parallelbrusheddataarr.length; i++)
            {
                if ((parallelbrusheddataarr[i][parallelbrushedcolumn] > brushedmin) && (parallelbrusheddataarr[i][parallelbrushedcolumn] < brushedmax))
                {
                    paralleltemp.push(parallelbrusheddataarr[i]);
                    testforlgacode.push(parallelbrusheddataarr[i].LGA_code);
                }
            }

            //console.log(paralleltemp);
            // var tempfornaming = [];
            // if (paralleltemp.length <= 3)
            // {
            //     tempfornaming.push(paralleltemp);
            // }
            // if (tempfornaming[0].length > 0)
            // {
            //     d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right').tickValues(tempfornaming[0].map(function(p) { return p["LGA_Name"]; })))
            // }
            // console.log(testarr);
            // console.log(testforfiltering);
            // console.log(testforlgacode);

            const newcountarr = testarr.filter((x) => x === true);
            console.log(newcountarr.length); //number of true value


            console.log(testforfiltering)
            let objGroup = testforlgacode.reduce(function (obj, name) {
                obj[name] = obj[name] ? ++obj[name] : 1;
                return obj;
            }, {});

            //objKey是对象的键名构成的数组
            let objKey = Object.keys(objGroup);

            //objValue是对象的值构成的数组
            let objValue = Object.values(objGroup);

            // console.log(objGroup);
            // console.log(objKey);//objKey是对象的键名构成的数组
            // console.log(objValue);////objValue是对象的值构成的数组
            // console.log(paralleltemp);

            for (var q = 0; q < objValue.length; q++)
            {
                if((objValue[q] == newcountarr.length) && (newcountarr.length < 3))
                {
                    for (var w = 0 ; w < paralleltemp.length; w++)
                    {
                        if (paralleltemp[w].LGA_code == objKey[q])
                        {
                            finaldatafilteringforPC.push(paralleltemp[w]);
                        }

                    }
                }
            }
            uniquearr(finaldatafilteringforPC);
            console.log(finaldatafilteringforPC);
            if (finaldatafilteringforPC.length < 5)
            {
                d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right')
                    .tickValues(finaldatafilteringforPC.map(function(p) { return p["LGA_Name"]; })))
            }



        }

    });


    d3.json("./Datafiles/lga-v4.json", function(error, graph) {


        //console.log(graph);
        var linkedByIndex = {};
        graph.links.forEach(function(d) {
            linkedByIndex[d.source + "," + d.target] = true;
        });
        //console.log(graph.nodes);

        function isConnected2(a, b) {
            let connected = false;
            for (let i = 0;i < graph.links.length;i++) {
                let link = graph.links[i];
                if (((link.source.index === a.index) && (link.target.index === b.index)) ||
                    ((link.target.index === a.index) && (link.source.index === b.index)) ||
                    (a.index === b.index)) {
                    connected = true;
                }
            }
            return connected;
        }


        function isConnected(a, b) {
            return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
        }

        function areConnected(a, b, d) {
            return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
        }

        function hasConnections(a) {
            for (var property in linkedByIndex) {
                s = property.split(",");
                if ((s[0] == a.index || s[1] == a.index) && linkedByIndex[property])
                    return true;
            }
            return false;
        }



        //删除数组，_arr:数组，_obj:需删除的对象
        function removeAaary(_arr, _obj) {
            var length = _arr.length;
            for (var i = 0; i < length; i++) {
                if (_arr[i] == _obj) {
                    if (i == 0) {
                        _arr.shift(); //删除并返回数组的第一个元素
                        return _arr;
                    }
                    else if (i == length - 1) {
                        _arr.pop();  //删除并返回数组的最后一个元素
                        return _arr;
                    }
                    else {
                        _arr.splice(i, 1); //删除下标为i的元素
                        return _arr;
                    }
                }
            }
        }


        allouterresults = outerpiecolumn;

        //var allresultslength = 53; //weekdate in one year
        var allresultslength = 53; //fortnightweekdate in two year
        var allresultinnerlength = 9; //innerlength of data columns
        //console.log(allouterresults);

        var testdata = [];
        var exampledata = [];

        //set rna parameters
        var malenumberarr = [];
        var femalenumberarr = [];
        var incomenumberarr = [];
        var lonenumberarr = [];
        var gendernumbermax;
        var incomenumbermax;
        var lonenumbermax;

        var exampledataeachlevels = [];
        //var exampledataeachlevels2 = [];


        for (var i = 0; i < graph.nodes.length; i++)
        {
            var startparameters = 1;
            var startparameters2 = 1;
            var startparameters3 = 1;

            var dataeachlevels = [];
            var dataeachlevels2 = [];
            //console.log(graph.nodes);

            //var newmapdatalevel = [];
            //var numberofzhongshan = 0, numberofnankai = 0, numberofwuhan = 0;

            var newmapdataonepointtotalcases = 0;
            for (var j = 0; j<graph.nodes[i].proportions.length; j++) {
                //console.log(graph.nodes[i]);
                var tempvalue = 0;
                if (typeof(parallelforinteraction[i]) == "undefined") {
                    tempvalue = 0;
                }
                else{
                    tempvalue = 10000 / Number(parallelforinteraction[i]["Population"]);
                }

                if (graph.nodes[i].proportions[j].valuetype == 'Confirmed')
                {

                    dataeachlevels.push({
                        'casespop': graph.nodes[i].proportions[j].cases * tempvalue,
                        'cases': graph.nodes[i].proportions[j].cases,
                        'week': graph.nodes[i].proportions[j].week,
                        'weekdate': graph.nodes[i].proportions[j].weekdate,
                        'valuetype': graph.nodes[i].proportions[j].valuetype,
                        //'mark' : graph.nodes[i].number
                    });

                }
                if ((i==0)&&(graph.nodes[i].proportions[j].valuetype == 'Confirmed'))
                {

                    exampledataeachlevels.push({
                        'cases': 5,
                        'week': graph.nodes[0].proportions[j].week,
                        'weekdate': graph.nodes[0].proportions[j].weekdate,
                        'valuetype': graph.nodes[0].proportions[j].valuetype
                    });
                }
                //mark not suitable for exampledata

            }
            //console.log(Newmapdata);
            //sum newmapdata for each node

            for (var k = 0; k<graph.nodes[i].columns.length; k++) {

                //console.log(graph.nodes[i].columns[k]);

                dataeachlevels2.push({
                    'columnvalue': graph.nodes[i].columns[k].columnvalue,
                    'columnname': graph.nodes[i].columns[k].columnname
                });

                if (graph.nodes[i].columns[k].columnname == 'HighriskFemale')
                {
                    femalenumberarr.push(graph.nodes[i].columns[k].columnvalue);
                    //console.log(tempnumber);
                    rankingfemalenumber.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });

                }
                else if (graph.nodes[i].columns[k].columnname == 'HighriskMale')
                {
                    malenumberarr.push(graph.nodes[i].columns[k].columnvalue);
                    rankingmalenumber.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'LowIncomePersons')
                {
                    incomenumberarr.push(graph.nodes[i].columns[k].columnvalue);
                    rankingpovertynumber.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'LonePerson')
                {
                    lonenumberarr.push(graph.nodes[i].columns[k].columnvalue);
                    rankinglonenumber.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'HighriskFemalePercent')
                {
                    rankingfemalepercent.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'HighriskMalePercent')
                {
                    rankingmalepercent.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'LowIncomePercent')
                {
                    rankingpovertypercent.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }
                else if (graph.nodes[i].columns[k].columnname == 'LonePersonPercent')
                {
                    rankinglonepercent.push({
                        index: i,
                        value : graph.nodes[i].columns[k].columnvalue
                    });
                }

            }
            //end of all loading data from lga


            //console.log(dataeachlevels.length);
            //console.log(tempnumber);
            //console.log(rankingmalenumber);

            for (var b = 0; b <dataeachlevels.length; b++)
            {

                dataeachlevels[b]['start'] = 360 / allresultslength * (startparameters - 1);
                dataeachlevels[b]['end'] = 360 / allresultslength * startparameters;
                dataeachlevels[b]['index'] = startparameters - 1 ;

                startparameters ++;
            }
            for (var d = 0; d <exampledataeachlevels.length; d++)
            {

                exampledataeachlevels[d]['start'] = 360 / allresultslength * (startparameters3 - 1);
                exampledataeachlevels[d]['end'] = 360 / allresultslength * startparameters3;
                exampledataeachlevels[d]['index'] = startparameters3 - 1 ;

                startparameters3 ++;
            }
            //console.log(exampledataeachlevels);

            // for (var c = 0; c <dataeachlevels2.length; c++)
            // {
            //
            //     dataeachlevels2[c]['start'] = 360 / allresultinnerlength * (startparameters2 - 1);
            //     dataeachlevels2[c]['end'] = 360 / allresultinnerlength * startparameters2;
            //
            //     startparameters2 ++;
            // }

            //分割字符串，split string
            //var idname = graph.nodes[i].id.split(".");
            //var tempidname = idname[idname.length - 2];
            //console.log(idname);


            if (graph.nodes[i].id != "Notstated"){
                testdata.push({
                    'id': graph.nodes[i].id,
                    'idname': graph.nodes[i].idname,
                    'lganame': graph.nodes[i].lganame,
                    'index': i,
                    'proportions': dataeachlevels,
                    'columns': dataeachlevels2
                    //'numberofexistingdata': numberofzhongshan + numberofnankai + numberofwuhan,
                    //'numberofzhongshan': numberofzhongshan,
                    //'numberofnankai': numberofnankai,
                    //'numberofwuhan': numberofwuhan
                });
            }



            //get new arrarw of node count here
            clickcircle0flag.push(0);

        }


        rankingmalenumber.sort(sortRule);
        rankingmalepercent.sort(sortRule);
        rankingfemalenumber.sort(sortRule);
        rankingfemalepercent.sort(sortRule);
        rankinglonenumber.sort(sortRule);
        rankinglonepercent.sort(sortRule);
        rankingpovertynumber.sort(sortRule);
        rankingpovertypercent.sort(sortRule);


        //console.log(rankingmalenumber);

        exampledata.push({
            'id': '000000',
            'idname': 'LGA',
            'lganame': 'LGA',
            'index': '00',
            'proportions': exampledataeachlevels
            // 'columns': dataeachlevels2
            //'numberofexistingdata': numberofzhongshan + numberofnankai + numberofwuhan,
            //'numberofzhongshan': numberofzhongshan,
            //'numberofnankai': numberofnankai,
            //'numberofwuhan': numberofwuhan
        });

        for (var q = 0; q < exampledata[0].proportions.length; q++)
        {
            examplepieclickflag.push(0);
        }
        //console.log(examplepieclickflag);

        legendtempdata = testdata;

        if (Math.max(...femalenumberarr) <= Math.max(...malenumberarr))
        {
            gendernumbermax = Math.max(...malenumberarr);
        }
        else
        {
            gendernumbermax = Math.max(...femalenumberarr);
        }
        incomenumbermax = Math.max(...incomenumberarr);
        lonenumbermax = Math.max(...lonenumberarr);

        //console.log(Math.max(...femalenumberarr));
        //console.log(Math.max(...malenumberarr));

        force
            .nodes(testdata)
            .links(graph.links)
            .linkDistance(function (d) {
                return d.length / 8;
            })
            .start();
        //console.log(linespeed);
        //console.log(graph.links);


        var link = g.selectAll(".link")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            // .style("stroke-width",nominal_stroke)
            .style("stroke-width", function(d) {
                return d.width; })
            .style("stroke-opacity", 0);


        var drag = force.drag()
            .on("dragstart", dragstart)
            .on("drag", dragged)
            .on("dragend", dragend);

        function dragstart(d) {
            d3.select(this).classed("fixed", d.fixed = true);

        }

        function dragged(d) {
            d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
            // circle.style("opacity", 1)
            //     .style("stroke-width", nominal_stroke)
            //     .style(towhite, "black")
        }

        function dragend(d) {
            d3.select(this).classed("active", false);
            //circle.style(towhite, "white");
        }


        function dblclick(d,o) {
            //alert(d.id);
            d3.select('#circle0-'+d.id).classed("fixed", d.fixed = false);

            d3.select('#circle0-'+d.id).style('fill','white').style("opacity", 1);
            //d3.select('#text-'+ o).style("font-size", "5px");
            clickcircle0flag[d.id] = 0;

        }



        // Toggle children on click.
        function nodeclick(d,o) {
            //alert('2');
            if (d3.event.defaultPrevented) {
                return;
            }

        }

        function Foundconnection(d){
            var thisindex = d.index;
            var temparr = {
                connectwith: [],
                connectto: []
            };

            //console.log(temparr);

            for (var i = 0; i < graph.links.length; i ++) {
                //console.log(graph.links[i]);
                if (thisindex == graph.links[i].source.index)
                {
                    //console.log(graph.links[i].source);
                    temparr.connectto.push(graph.links[i].target.index);
                }
                if (thisindex == graph.links[i].target.index)
                {
                    temparr.connectwith.push(graph.links[i].source.index);
                }
            }
            return temparr;
        }

        var div = d3.select("body")
            .append("div")
            .attr("class", "smallwindow");

        var divinner = d3.select("body")
            .append("div")
            .attr("class", "divinner");

        var divinner2 = d3.select("body")
            .append("div")
            .attr("class", "divinner2");

        var divlegend = d3.select("body")
            .append("div")
            .attr("class", "divlegend");

        var nodelegend = lg.selectAll(".node")
            .data(exampledata)
            .enter()
            .append("g")
            .attr('id', function(d, i) {
                return 'node-000'
            })
            .attr("class", "node")
            .attr("transform", "translate(" + dragwindowwidth / 2 + "," + dragwindowheight / 2 + ")")


        //examplepie
        var examplepie = d3.layout.pie()
            //.data(allouterresults)
            // .sort(d3.descending)
            .sort(null)
            //默认降序排列，除非传入null

            .value(function(d) {
                //console.log(d);
                return d.cases;
            });

        var examplearc = d3.svg.arc()

            .startAngle(function(d) { return d.data.start * 2 * Math.PI/360;})
            .endAngle(function(d) { return d.data.end * 2 * Math.PI/360; })
            .innerRadius(72)
            .outerRadius(90)

            //外部高低
            .cornerRadius(50);

        //draw examplepiesymbol
        var examplepiesymbol = d3.select('#node-000').selectAll("path");
        examplepiesymbol.data(function(d, i) {
            //console.log(d.proportions);
            return examplepie(d.proportions);
        })

            .enter()

            .append("path")

            .attr("d", examplearc)
            .attr('id', function(d, o) {
                //console.log(d);
                //console.log(o);
                return 'examplepiebar-' + o;
            })

            .style(tocolor, function(d, o) {
                //o = week - 1
                //worse
                //console.log(interventionarr);
                // for (var i = 0; i < interventionarr.length; i++){
                //     if ((o == Number(interventionarr[i].weekfrom)) && (interventionarr[i].categroy == "0") && (o <= Number(interventionarr[i].weekto))){
                //         return ColorGreyforExample[1];
                //     }
                //     else if ((o == Number(interventionarr[i].weekfrom)) && (interventionarr[i].categroy == "1") && (o <= Number(interventionarr[i].weekto))){
                //         return ColorGreyforExample[2];
                //     }
                //     else{
                //         return ColorGreyforExample[0];
                //     }
                // }
                //
                // if ((o == 12)||(o == 13)||(o == 14)||(o == 15)||(o == 16)||(o == 17)||(o == 18)||(o == 19)||(o == 20)||
                //     (o == 21)||(o == 22)||(o == 23)||(o == 24)||(o == 25)||(o == 27)||(o == 42)||(o == 50)||(o == 51)||(o == 52))
                // {
                //     return ColorGreyforExample[1]
                // }
                // //worst
                // if ((o == 28)||(o == 29)||(o == 30)||(o == 31)||(o == 32)||
                //     (o == 33)||(o == 34)||(o == 35)||(o == 36)||(o == 37)||(o == 38)||(o == 39)||(o == 40)||(o == 41))
                // {
                //     return ColorGreyforExample[2]
                // }
                //normal

                if ((o == 5)||(o == 6)||(o == 7)||(o == 8)||(o == 9)||(o == 10)
                    ||(o == 12)||(o == 13)||(o == 14)||(o == 15)||(o == 16)||(o == 17)||(o == 18)||(o == 19)||(o == 20)||(o == 21)||(o == 22)||(o == 23)
                    ||(o == 23)||(o == 24)
                    ||(o == 36)||(o == 37)||(o == 38)||(o == 39)||(o == 40)||(o == 41)||(o == 42)||(o == 43)){
                    return ColorGreyforExample[2]
                }

                else if ((o == 6)||(o == 7)||(o == 8)||(o == 9)
                    ||(o == 10)||(o == 11)
                    ||(o == 13)||(o == 14)||(o == 15)||(o == 16)||(o == 17)||(o == 18)||(o == 19)
                    ||(o == 23)||(o == 24)||(o == 25)||(o == 26)||(o == 27)||(o == 28)
                    ||(o == 39)||(o == 40)||(o == 41)||(o == 42)||(o == 43)
                    ||(o == 45)||(o == 46)||(o == 47)||(o == 48)||(o == 49)||(o == 50)||(o == 51)||(o == 52)){
                    return ColorGreyforExample[1]
                }
                else{
                    return ColorGreyforExample[0];
                }

            })
            //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
            .style("stroke-width", nominal_stroke)

            .on("click",function(d, o){
                if (d3.event.defaultPrevented) {
                    return;
                }
                examplepieclickflag[o] = 1;
                d3.selectAll('#piebar-' + o)
                    .style("opacity", 1)
                    .style("stroke-width", nominal_stroke)
                    .style("stroke", "black");
                d3.select('#examplepiebar-' + o)
                    // .style("opacity", 1)
                    // .style("stroke-width", 0)
                    // .style("opacity", 1)
                    // .style("stroke", "white")
                    // .style("fill", "black");
                    .style("opacity", 1)
                    .style("stroke-width", nominal_stroke + 2.5)
                    .style("stroke", "black");
                //writing events happened



            })
            .on("mousemove",function(d,o){


                d3.selectAll('#piebar-' + o)
                    .style("opacity", 1)
                    .style("stroke-width", nominal_stroke)
                    .style("stroke", "black");
                d3.select('#examplepiebar-' + o)
                    .style("opacity", 1)
                    .style("stroke-width", nominal_stroke + 1.5)
                    .style("stroke", "black");

                //writing events happened
                //console.log(d3.select("#text-000"));
                var tempevents = "";
                var temprows = 1.9;
                //console.log(o);
                if ((o == 5)||(o == 6)||(o == 7)||(o == 8)||(o == 9)||(o == 10)){
                    tempevents += "NSW Lockdown" + ", ";
                    temprows+= 0.6;

                }
                if((o == 12)||(o == 13)||(o == 14)||(o == 15)||(o == 16)||(o == 17)||(o == 18)||(o == 19)||(o == 20)||(o == 21)||(o == 22)||(o == 23)){
                    tempevents += "New NSW Lockdown" + ", ";
                    temprows+= 0.6;
                }
                if((o == 23)||(o == 24)){
                    tempevents += "Northern Sydney Lockdown" + ", ";
                    temprows+= 0.6;
                }

                if((o == 36)||(o == 37)||(o == 38)||(o == 39)||(o == 40)||(o == 41)||(o == 42)||(o == 43)){
                    tempevents += "New Sydney Lockdown" + ", ";
                    temprows+= 0.6;
                }

                if ((o == 6)||(o == 7)||(o == 8)||(o == 9)) {
                    tempevents += "Covid-19 Restriction" + ", ";
                    temprows+= 0.6;
                }
                if((o == 10)||(o == 11)){
                    tempevents += "New Covid-19 Restriction" + ", ";
                    temprows+= 0.6;
                }
                if((o == 13)||(o == 14)||(o == 15)||(o == 16)||(o == 17)||(o == 18)||(o == 19)){
                    tempevents += "NSW Restriction" + ", ";
                    temprows+= 0.6;
                }
                if((o == 23)||(o == 24)||(o == 25)||(o == 26)||(o == 27)||(o == 28)){
                    tempevents += "Greater Sydney Restriction" + ", ";
                    temprows+= 0.6;
                }
                if((o == 39)||(o == 40)||(o == 41)||(o == 42)||(o == 43)){
                    tempevents += "New Sydney Restriction" + ", ";
                    temprows+= 0.6;
                }
                if((o == 45)||(o == 46)||(o == 47)||(o == 48)||(o == 49)||(o == 50)||(o == 51)||(o == 52)){
                    tempevents += "NSW Reopening Restriction" + ", ";
                    temprows+= 0.6;
                }

                else if (tempevents == ""){
                    tempevents = "Null, ";
                }
                //preparing to delete ends





                tempevents = tempevents.substring(0,tempevents.length-2);

                // console.log(o);
                d3.select("#text-000").text("Week "+ (d.data.week*2 - 1) + " - " + (d.data.week*2));
                //d3.select("#text-000").text("Fort "+ d.data.week);

                divlegend.style("display","none");

                divlegend.html("Date: "+ d.data.weekdate +"</br> Event: "+ tempevents +"</br>")

                    .style("left", (d3.event.pageX+12) + "px")
                    .style("top", (d3.event.pageY-10) + "px")
                    .style("opacity", 0.8)
                    .style("height", function(){
                        //console.log(tempevents);
                        return 23 * temprows + 'px';
                    })
                    .style("display","block");


                //console.log(d);



            })
            .on("mouseout",function(d,o){



                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 0)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                            d3.select('#examplepiebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                        }

                    }
                    d3.select("#text-000").text('LGA');
                    divlegend.style("display","none");



            });

        //exampleothers
        var examplecircle = nodelegend.append("path")
            .attr('class', "circle")
            .attr("d", d3.svg.symbol()
                .size(15000))
            // .size(function(d) { return Math.PI*Math.pow(size(d.size)||nominal_base_node_size,2); }))
            // .type(function(d) { return d.type; }))

            // .style(tocolor, 'white')
            // .style('fill-opacity', 0)

            //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })

            .style("stroke-width", nominal_stroke)
            .style(towhite, "black")
            .style("stroke-opacity", 0.8)

            .style('fill', 'none')

            .on("mousemove",function(d){


            })
            .on("mouseout",function(){

            });



        var examplecircle0 = nodelegend.append("path")
            .attr('class', "circle")
            .attr("d", d3.svg.symbol()
                .size(3500))
            // .size(function(d) { return Math.PI*Math.pow(size(d.size)||nominal_base_node_size,2); }))
            // .type(function(d) { return d.type; }))
            .attr('id', function(d, i) {
                return 'circle000-' + d.id
            })
            .style(tocolor, 'white')
            .style('fill-opacity', 1)
            //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
            .style("stroke-width", nominal_stroke)
            .style(towhite, "black")
            .style("stroke-opacity", 0.1)
            .on("mousemove",function(d){


            })
            .on("mouseout",function(){

            })
            .on('click',function(d,o){
                if (d3.event.defaultPrevented) {
                    return;
                }

            })
            .on('dblclick',function(d,o){

            });




        var maledegreeexample =  Math.PI;
        var femaledegreeexample = Math.PI;
        var incomedegreeexample = Math.PI * 2;
        var lonedegreeexample = Math.PI * 2;

        var malefrenquencyexample = 15;
        var femalefrenquencyexample = 15;
        var incomefrequencyexample = 15;
        var lonefrenquencyexample = 15;


        //console.log(temp.columns[10].columnvalue);
        //console.log(gendernumbermax);
        //console.log(femaledegree);
        //console.log(temp.columns[10].columnvalue);

        let angles0example = d3v5.range(0, femaledegreeexample, Math.PI / 360);
        let line0example = d3v5.lineRadial()
            .curve(d3v5.curveCatmullRom)
            .angle((d) => { return d })
            .radius((d) => { return (58 + 9 * Math.abs(Math.cos(malefrenquencyexample * d))) })

        let angles1example = d3v5.range(- maledegreeexample, 0, Math.PI / 360);
        let line1example = d3v5.lineRadial()
            .curve(d3v5.curveCatmullRom)
            .angle((d) => { return d })
            .radius((d) => { return (57 + 9 * Math.abs(Math.cos(femalefrenquencyexample * d))) })

        let angles2example = d3v5.range(0,  incomedegreeexample, Math.PI / 360);
        let line2example = d3v5.lineRadial()
            .curve(d3v5.curveCatmullRom)
            .angle((d) => { return d })
            .radius((d) => { return (47 + 9 * Math.abs(Math.cos(incomefrequencyexample * d))) })

        let angles3example = d3v5.range(0, lonedegreeexample, Math.PI / 360);
        let line3example = d3v5.lineRadial()
            .curve(d3v5.curveCatmullRom)
            .angle((d) => { return d })
            .radius((d) => { return (37 + 9 * Math.abs(Math.cos(lonefrenquencyexample * d))) })

        var examplewave1flag = false;
        var examplewave2flag = false;
        var examplewave3flag = false;
        var examplewave4flag = false;

        var sinewaveexample = d3v5.select('#node-000');

        //male sine
        sinewaveexample.append('g')
            .attr("transform", "translate(0,0)")
            .append('path')
            .attr('d', line0example(angles0example))
            .attr("stroke", function ()
            {
                return Colorsinepannel[1];
            })
            .attr("stroke-width", 3)
            .attr("fill", "none")
            .attr('id', function() {
                return 'waveexample-1';
            })
            .on("mousemove",function(d, o){

                //console.log(o);

                d3.selectAll('#wave-1')
                    .style("opacity", 1)
                d3.selectAll('#wave-2')
                    .style("opacity", 0)
                d3.selectAll('#wave-3')
                    .style("opacity", 0)
                d3.selectAll('#wave-4')
                    .style("opacity", 0)
                for (var a = 0 ; a < rankingfemalenumber.length; a++)
                {
                    d3.select('#text-'+ rankingfemalenumber[a].index)
                        .attr("dy", "-0.35em")
                        .style("font-size", "7px");

                    d3.select('#textranking-' + rankingfemalenumber[a].index)
                        .text('#' + (a + 1))
                        .style("font-size", "7px");
                }
                d3.select("#text-000").text("Aged Female");


            })
            .on("mouseout",function(){
                d3.select("#text-000").text("LGA");
                d3.selectAll('#wave-1')
                    .style("opacity", 1)
                d3.selectAll('#wave-2')
                    .style("opacity", 1)
                d3.selectAll('#wave-3')
                    .style("opacity", 1)
                d3.selectAll('#wave-4')
                    .style("opacity", 1)

                div.html(" ").style("display","none");
                //console.log(exampleclickflag);
                if (exampleclickflag == 1) //whether clicked filter button
                {
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        //console.log(examplepieclickflag[a]);
                        if (examplepieclickflag[a] == 0)
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", highlight_trans)
                                .style("stroke", "white");

                    }
                    // //  如果不相连，将所有节点的透明度置为0.1
                    // d3.select('#node-' + o.index)
                    //     .selectAll('path')
                    //     .style("opacity", highlight_trans)

                }
                else{
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 0)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                        }

                    }
                    for (var c = 0 ; c < clickcircle0flag.length; c++)
                    {

                        d3.selectAll('#text-' + c)
                            .attr("dy", "0.35em")
                            .style("font-size", function (){
                                if (clickcircle0flag[c] == 1)
                                {
                                    return "7px";
                                }
                                else
                                {
                                    return "5px"
                                }
                            })
                            .style('opacity', 1);
                        d3.select('#textranking-' + c)
                            .text([])
                    }
                }

                //console.log(sumupcases);

                if (ranksavingwordsafterselect.length > 0){
                    for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                    {
                        d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                            .attr("dy", "-0.35em")
                            .style("font-size", "7px");

                        d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                            .text(ranksavingwordsafterselect[t].content)
                            .style("font-size", "7px");
                    }
                }

            })
            .on("click", function() {

            });


        sinewaveexample.append('g')
            .attr("transform", "translate(0,0)")
            .append('path')
            .attr('d', line1example(angles1example))
            .attr("stroke", function ()
            {
                return Colorsinepannel[0];
            })
            .attr("stroke-width", 3)
            .attr("fill", "none")
            .attr('id', function() {
                return 'waveexample-2';
            })
            .on("mousemove",function(d, o){
                d3.select("#text-000").text("Aged Male");
                d3.selectAll('#wave-1')
                    .style("opacity", 0)
                d3.selectAll('#wave-2')
                    .style("opacity", 1)
                d3.selectAll('#wave-3')
                    .style("opacity", 0)
                d3.selectAll('#wave-4')
                    .style("opacity", 0)

                for (var a = 0 ; a < rankingmalenumber.length; a++)
                {

                    d3.select('#text-'+ rankingmalenumber[a].index)
                        .attr("dy", "-0.35em")
                        .style("font-size", "7px");

                    d3.select('#textranking-' + rankingmalenumber[a].index)
                        .text('#' + (a + 1))
                        .style("font-size", "7px");
                }


            })
            .on("mouseout",function(){
                d3.select("#text-000").text("LGA");
                d3.selectAll('#wave-1')
                    .style("opacity", 1)
                d3.selectAll('#wave-2')
                    .style("opacity", 1)
                d3.selectAll('#wave-3')
                    .style("opacity", 1)
                d3.selectAll('#wave-4')
                    .style("opacity", 1)

                div.html(" ").style("display","none");
                //console.log(exampleclickflag);
                if (exampleclickflag == 1) //whether clicked filter button
                {
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        //console.log(examplepieclickflag[a]);
                        if (examplepieclickflag[a] == 0)
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", highlight_trans)
                                .style("stroke", "white");

                    }
                    // //  如果不相连，将所有节点的透明度置为0.1
                    // d3.select('#node-' + o.index)
                    //     .selectAll('path')
                    //     .style("opacity", highlight_trans)

                }
                else{
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 0)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                        }

                    }
                    for (var c = 0 ; c < clickcircle0flag.length; c++)
                    {

                        d3.selectAll('#text-' + c)
                            .attr("dy", "0.35em")
                            .style("font-size", function (){
                                if (clickcircle0flag[c] == 1)
                                {
                                    return "7px";
                                }
                                else
                                {
                                    return "5px"
                                }
                            })
                            .style('opacity', 1);
                        d3.select('#textranking-' + c)
                            .text([])
                    }
                }

                //console.log(sumupcases);

                if (ranksavingwordsafterselect.length > 0){
                    for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                    {
                        d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                            .attr("dy", "-0.35em")
                            .style("font-size", "7px");

                        d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                            .text(ranksavingwordsafterselect[t].content)
                            .style("font-size", "7px");
                    }
                }
            })
            .on("click", function() {

            });


        sinewaveexample.append('g')
            .attr("transform", "translate(0,0)")
            .append('path')
            .attr('d', line2example(angles2example))
            .attr("stroke", function ()
            {
                return Colorsinepannel[2];
            })
            .attr("stroke-width", 3)
            .attr("fill", "none")
            .attr('id', function(d, o) {
                return 'waveexample-3';
            })
            .on("mousemove",function(d, o){
                d3.select("#text-000").text("Lower Income");
                d3.selectAll('#wave-1')
                    .style("opacity", 0)
                d3.selectAll('#wave-2')
                    .style("opacity", 0)
                d3.selectAll('#wave-3')
                    .style("opacity", 1)
                d3.selectAll('#wave-4')
                    .style("opacity", 0)
                for (var a = 0 ; a < rankingpovertynumber.length; a++)
                {
                    d3.select('#text-'+ rankingpovertynumber[a].index)
                        .attr("dy", "-0.35em")
                        .style("font-size", "7px");

                    d3.select('#textranking-' + rankingpovertynumber[a].index)
                        .text('#' + (a + 1))
                        .style("font-size", "7px");
                }
            })
            .on("mouseout",function(){
                d3.select("#text-000").text("LGA");
                d3.selectAll('#wave-1')
                    .style("opacity", 1)
                d3.selectAll('#wave-2')
                    .style("opacity", 1)
                d3.selectAll('#wave-3')
                    .style("opacity", 1)
                d3.selectAll('#wave-4')
                    .style("opacity", 1)

                div.html(" ").style("display","none");
                //console.log(exampleclickflag);
                if (exampleclickflag == 1) //whether clicked filter button
                {
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        //console.log(examplepieclickflag[a]);
                        if (examplepieclickflag[a] == 0)
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", highlight_trans)
                                .style("stroke", "white");

                    }
                    // //  如果不相连，将所有节点的透明度置为0.1
                    // d3.select('#node-' + o.index)
                    //     .selectAll('path')
                    //     .style("opacity", highlight_trans)

                }
                else{
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 0)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                        }

                    }
                    for (var c = 0 ; c < clickcircle0flag.length; c++)
                    {

                        d3.selectAll('#text-' + c)
                            .attr("dy", "0.35em")
                            .style("font-size", function (){
                                if (clickcircle0flag[c] == 1)
                                {
                                    return "7px";
                                }
                                else
                                {
                                    return "5px"
                                }
                            })
                            .style('opacity', 1);
                        d3.select('#textranking-' + c)
                            .text([])
                    }
                }

                //console.log(sumupcases);

                if (ranksavingwordsafterselect.length > 0){
                    for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                    {
                        d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                            .attr("dy", "-0.35em")
                            .style("font-size", "7px");

                        d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                            .text(ranksavingwordsafterselect[t].content)
                            .style("font-size", "7px");
                    }
                }
            })
            .on("click", function() {

            });


        sinewaveexample.append('g')
            .attr("transform", "translate(0,0)")
            .append('path')
            .attr('d', line3example(angles3example))
            .attr("stroke", function ()
            {
                return Colorsinepannel[3];
            })
            .attr("stroke-width", 3)
            .attr("fill", "none")
            .attr('id', function(d, o) {
                return 'waveexample-4';
            })
            .on("mousemove",function(d, o){
                d3.select("#text-000").text("Lone Person");
                //console.log(d);
                d3.selectAll('#wave-1')
                    .style("opacity", 0)
                d3.selectAll('#wave-2')
                    .style("opacity", 0)
                d3.selectAll('#wave-3')
                    .style("opacity", 0)
                d3.selectAll('#wave-4')
                    .style("opacity", 1)
                for (var a = 0 ; a < rankinglonenumber.length; a++)
                {
                    d3.select('#text-'+ rankinglonenumber[a].index)
                        .attr("dy", "-0.35em")
                        .style("font-size", "7px");

                    d3.select('#textranking-' + rankinglonenumber[a].index)
                        .text('#' + (a + 1))
                        .style("font-size", "7px");
                }
            })
            .on("mouseout",function(){
                d3.select("#text-000").text("LGA");
                d3.selectAll('#wave-1')
                    .style("opacity", 1)
                d3.selectAll('#wave-2')
                    .style("opacity", 1)
                d3.selectAll('#wave-3')
                    .style("opacity", 1)
                d3.selectAll('#wave-4')
                    .style("opacity", 1)

                div.html(" ").style("display","none");
                //console.log(exampleclickflag);
                if (exampleclickflag == 1) //whether clicked filter button
                {
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        //console.log(examplepieclickflag[a]);
                        if (examplepieclickflag[a] == 0)
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", highlight_trans)
                                .style("stroke", "white");

                    }
                    // //  如果不相连，将所有节点的透明度置为0.1
                    // d3.select('#node-' + o.index)
                    //     .selectAll('path')
                    //     .style("opacity", highlight_trans)

                }
                else{
                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 0)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("stroke-width", 0)
                                .style("opacity", 1)
                                .style("stroke", "white");
                        }

                    }
                    for (var c = 0 ; c < clickcircle0flag.length; c++)
                    {

                        d3.selectAll('#text-' + c)
                            .attr("dy", "0.35em")
                            .style("font-size", function (){
                                if (clickcircle0flag[c] == 1)
                                {
                                    return "7px";
                                }
                                else
                                {
                                    return "5px"
                                }
                            })
                            .style('opacity', 1);
                        d3.select('#textranking-' + c)
                            .text([])
                    }
                }

                //console.log(sumupcases);

                if (ranksavingwordsafterselect.length > 0){
                    for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                    {
                        d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                            .attr("dy", "-0.35em")
                            .style("font-size", "7px");

                        d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                            .text(ranksavingwordsafterselect[t].content)
                            .style("font-size", "7px");
                    }
                }
            })
            .on("click", function() {

            });


        nodelegend.append("svg:text")
            //.attr("class", "nodetext")
            .attr("font-family", "sans-serif")
            .attr("font-weight", 800)
            .attr("text-anchor", "middle")
            //居中
            .attr("dx", 0)
            .attr("dy", ".35em")
            .attr('id', function(d, i) {
                return 'text-000'
            })
            .text(function(d) {
                //console.log(d);
                return d.idname ;
            })
            .style(tocolor, 'black')
            .style("font-size", "13px")
            .on("mousemove",function(d){
                d3.select(this).style("font-size", "16px");

            })
            .on("mouseout",function(d,o){

                d3.select(this).style("font-size", "13px");

            });
        // .on("click", nodeclick)
        // .on("dblclick", dblclick);

        var exampletext = lg.selectAll(".text")
            // .data(graph.nodes)
            .data(['LGA'])
            //.data(testdata)
            .enter().append("text")
            // .attr("dx", -10)
            // .attr("dy", ".35em")
            .style("font-size", "18px");

        //console.log(testdata);

        if (text_center)
            exampletext.text(function(d) {
                if (typeof(d.id) !== 'undefined') {
                    return d.id;
                }
            })
                .style("text-anchor", "middle");
        else
            exampletext.attr("dx", function(d) {return (size(d.size)||nominal_base_node_size);})
                .text(function(d) {
                    if (typeof(d.id) !== 'undefined') {
                        return '\u2002'+d.id;
                    }
                });



        //END EXAMPLE



        var node = g.selectAll(".node")
            // .data(graph.nodes)
            .data(testdata)
            .enter()
            .append("g")
            .attr('id', function(d, i) {
                return 'node-' + d.index
            })
            .attr("class", "node")

            .call(drag);

        node
            // .data(graph.nodes)
            .append("g")
            .attr('id', function(d, i) {
                return 'node0-' + d.index
            })
            .attr("class", "node")

            .call(drag);



        var pie = d3.layout.pie()
            //.data(allouterresults)
            // .sort(d3.descending)
            .sort(null)
            //默认降序排列，除非传入null


            .value(function(d) {
                //console.log(d);
                return d.cases;
                //return d.cases;
            });



        var arc = d3.svg.arc()

            .startAngle(function(d) { return d.data.start * 2 * Math.PI/360;})
            .endAngle(function(d) { return d.data.end * 2 * Math.PI/360; })
            .innerRadius(29)
            .outerRadius(function (d) {
                //console.log(d);
                if( d.value > 0){
                    return 32 + outradius * (1.4 + Math.log(d.value + 1) * 1.2);
                }
                else if (d.value == 1)
                {
                    return 30 + 3
                }
                else{
                    return 30 + 2;
                }
            })

            //外部高低
            .cornerRadius(50);

        var piesymbol;
        node.each(function(temp) {
            // var pieflag = 0;

            //draw piesymbol
            piesymbol = d3.select('#node-' + temp.index).selectAll("path");
            piesymbol.data(function(d, i) {
                //console.log(d.proportions);
                return pie(d.proportions);
            })

                .enter()
                .append("g")
                .attr('id', 'piebars')
                .append("path")

                .attr("d", arc)
                .attr('id', function(d, o) {
                    //console.log(d);
                    //console.log(o);
                    return 'piebar-' + o;
                })

                .style(tocolor, function(d) {
                    //console.log(d);
                    if ( d.data.cases == 0)
                        return ColorGrey[0];
                    else
                        return Flowercolorpannel[0];
                })
                //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
                .style("stroke-width", nominal_stroke)

                .on("click",function(d, o){
                    if (d3.event.defaultPrevented) {
                        return;
                    }

                    if (d._clickid) {
                        clearTimeout(d._clickid);
                        d._clickid = null;
                        // process double click
                        // ...
                        //alert('dragged');

                    } else {
                        d._clickid = setTimeout(function() {
                            d3.selectAll('#piebar-' + o)
                                .style("opacity", 1)
                                .style("stroke-width", nominal_stroke)
                                .style("stroke", "black")
                            d._clickid = null;

                            //alert('clicked');
                        }.bind(this), 250);
                    }
                    // console.log(ClickonPie);

                })


                .on("mousemove",function(d,o){
                    //console.log(d);
                    var mouseVal = d3.mouse(this);
                    var tempscore;
                    divinner2.style("display","none");

                    tempscore = d.data.cases;
                    divinner2.html("Category:"+d.data.valuetype+"</br>"+"Date:"+d.data.weekdate+"</br>"+"Cases:"+ tempscore)
                        .style("left", (d3.event.pageX+12) + "px")
                        .style("top", (d3.event.pageY-10) + "px")
                        .style("opacity", 0.8)
                        .style("display","block");

                    // d3.select(this)
                    //     .style("opacity", 1)
                    //     .style("stroke-width", nominal_stroke)
                    //     .style("stroke", "black");

                    //console.log(d3.selectAll('#piebar-' + o));

                    for (var a = 0; a < examplepieclickflag.length; a++)
                    {
                        if (examplepieclickflag[a] == 1)
                        {
                            d3.selectAll('#piebar-' + a)
                                .style("opacity", 1)
                                .style("stroke-width", nominal_stroke)
                                .style("stroke", "black")
                        }

                    }

                    d3.selectAll('#piebar-' + o)
                        .style("opacity", 1)
                        .style("stroke-width", nominal_stroke)
                        .style("stroke", "black");

                    d3.select('#examplepiebar-' + o)
                        .style("opacity", 1)
                        .style("stroke-width", nominal_stroke + 2.5)
                        .style("stroke", "black");

                    // console.log(d);
                    // console.log(mouseVal);

                    var savinghoveraddlastsumupcases = [];

                    if ((savinglastsumupcases.length > 0) && ( examplepieclickflag[d.data.index] == 0 ))
                    {

                        // console.log(savinglastsumupcases); // saving data last sum cases by filtering from panel
                        // console.log(d.data); // current node data in loop
                        // console.log(legendtempdata); // ALL DATA
                        // console.log(temp); // current node in loop

                        // savinghoveraddlastsumupcases = savinglastsumupcases;

                        //2ND TRY
                        for (var a = 0; a < savinglastsumupcases.length; a++)
                        {
                            if (savinglastsumupcases[a].origin != 129) //很不情愿的做法 129对应notstated
                            {
                                savinghoveraddlastsumupcases.push({
                                    value: savinglastsumupcases[a].value + legendtempdata[savinglastsumupcases[a].origin].proportions[d.data.index].cases,
                                    index: a,
                                    origin: savinglastsumupcases[a].origin

                                });
                            }


                        }

                        // console.log(savinghoveraddlastsumupcases);
                        // console.log(savinglastsumupcases);

                        savinghoveraddlastsumupcases.sort(sortRule);


                        let prevalue = 0;//预定义分数
                        let ranking = 0;//排名

                        savinghoveraddlastsumupcases.forEach((item,index)=> {

                            if (item.value == prevalue) {
                                item.index = ranking;
                            } else {
                                ranking++;
                                prevalue = item.value;
                                item.index = ranking;
                            }
                        })

                        // console.log(savinglastsumupcases);
                        //
                        // console.log(savinghoveraddlastsumupcases);

                        for (var c = 0 ; c < savinghoveraddlastsumupcases.length; c++)
                        {

                            d3.select('#text-'+ savinghoveraddlastsumupcases[c].origin)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + savinghoveraddlastsumupcases[c].origin)
                                .text('#' + savinghoveraddlastsumupcases[c].index)
                                .style("font-size", "7px");

                        }
                        // savinghoveraddlastsumupcases = [];

                    }

                    else if (savinglastsumupcases.length == 0)
                    {
                        for (var a = 0; a < legendtempdata.length; a++)
                        {
                            savinghoveraddlastsumupcases.push({
                                value: legendtempdata[a].proportions[d.data.index].cases,
                                index: a,
                                origin: a

                            });
                        }

                        savinghoveraddlastsumupcases.sort(sortRule);

                        let prevalue = 0;//预定义分数
                        let ranking = 0;//排名

                        savinghoveraddlastsumupcases.forEach((item,index)=> {
                            if (item.value == prevalue) {
                                item.index = ranking;
                            } else {
                                ranking++;
                                prevalue = item.value;
                                item.index = ranking;
                            }
                        })

                        // console.log(savinglastsumupcases);
                        //
                        // console.log(savinghoveraddlastsumupcases);

                        for (var c = 0 ; c < savinghoveraddlastsumupcases.length; c++)
                        {

                            d3.select('#text-'+ savinghoveraddlastsumupcases[c].origin)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + savinghoveraddlastsumupcases[c].origin)
                                .text('#' + (savinghoveraddlastsumupcases[c].index + 1))
                                .style("font-size", "7px");

                        }


                    }

                })
                .on("mouseout",function(d,o){
                    divinner2.html(" ").style("display","none");
                    console.log(exampleclickflag);
                    console.log(examplepieclickflag);
                    if (exampleclickflag == 1) //whether clicked filter button
                    {
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            // console.log(examplepieclickflag[a]);
                            if (examplepieclickflag[a] == 0)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("stroke-width", 0)
                                    .style("opacity", highlight_trans)
                                    .style("stroke", "white");
                                //未选中的标记为无黑边


                                d3.select('#examplepiebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", 0)
                                    .style("stroke", "white");



                            }
                            else
                            {
                                // d3.selectAll('#piebar-' + a)
                                //     .style("stroke-width", 0)
                                //     .style("opacity", 1)
                                //     .style("stroke", "white");
                                d3.select('#examplepiebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke + 1.5)
                                    .style("stroke", "black");

                            }


                        }
                        // //  如果不相连，将所有节点的透明度置为0.1
                        // d3.select('#node-' + o.index)
                        //     .selectAll('path')
                        //     .style("opacity", highlight_trans)

                    }
                    else{
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            if (examplepieclickflag[a] == 0)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("stroke-width", 0)
                                    .style("opacity", 1)
                                    .style("stroke", "white");
                                d3.select('#examplepiebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", 0)
                                    .style("stroke", "white");
                            }
                            else
                            {
                                d3.select('#examplepiebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke + 1.5)
                                    .style("stroke", "black");
                            }

                        }
                        for (var c = 0 ; c < clickcircle0flag.length; c++)
                        {

                            d3.selectAll('#text-' + c)
                                .attr("dy", "0.35em")
                                .style("font-size", function (){
                                    if (clickcircle0flag[c] == 1)
                                    {
                                        return "7px";
                                    }
                                    else
                                    {
                                        return "5px"
                                    }
                                })
                                .style('opacity', 1);
                            d3.select('#textranking-' + c)
                                .text([])
                        }
                    }


                    //console.log(sumupcases);

                    if (ranksavingwordsafterselect.length > 0){
                        for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                        {
                            d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                                .text(ranksavingwordsafterselect[t].content)
                                .style("font-size", "7px");
                        }
                    }


                })
            //console.log(piesymbol);


            //draw sine wave
            // define
            // var gendernumbermax;
            // var incomenumbermax;
            // var lonenumbermax;


            if (temp.idname != 'Notstated')
            {


                var maledegree = (temp.columns[11].columnvalue / (1.25 * gendernumbermax) + 1/5) * Math.PI;
                var femaledegree = (temp.columns[10].columnvalue / (1.25 * gendernumbermax) + 1/5) * Math.PI;
                var incomedegree = ( temp.columns[14].columnvalue / (1.25 * incomenumbermax) + 1/5) * Math.PI * 2;
                var lonedegree = (temp.columns[16].columnvalue / (1.25 * lonenumbermax) + 1/5) * Math.PI * 2;

                var malefrenquency = temp.columns[13].columnvalue * 250;
                var femalefrenquency = temp.columns[12].columnvalue * 250;
                var incomefrequency = temp.columns[15].columnvalue * 60;
                var lonefrenquency = temp.columns[17].columnvalue * 120;


                //console.log(temp.columns[10].columnvalue);
                //console.log(gendernumbermax);
                //console.log(femaledegree);
                //console.log(temp.columns[10].columnvalue);

                let angles0 = d3v5.range(0, femaledegree, Math.PI / 360);
                let line0 = d3v5.lineRadial()
                    .curve(d3v5.curveCatmullRom)
                    .angle((d) => { return d })
                    .radius((d) => { return (22 + 4.5 * Math.abs(Math.cos(malefrenquency * d))) })

                let angles1 = d3v5.range(- maledegree, 0, Math.PI / 360);
                let line1 = d3v5.lineRadial()
                    .curve(d3v5.curveCatmullRom)
                    .angle((d) => { return d })
                    .radius((d) => { return (22 + 4.5 * Math.abs(Math.cos(femalefrenquency * d))) })

                let angles2 = d3v5.range(0,  incomedegree, Math.PI / 360);
                let line2 = d3v5.lineRadial()
                    .curve(d3v5.curveCatmullRom)
                    .angle((d) => { return d })
                    .radius((d) => { return (17 + 4.5 * Math.abs(Math.cos(incomefrequency * d))) })

                let angles3 = d3v5.range(0, lonedegree, Math.PI / 360);
                let line3 = d3v5.lineRadial()
                    .curve(d3v5.curveCatmullRom)
                    .angle((d) => { return d })
                    //.radius((d) => { return (11 + 4.5 * Math.abs(Math.cos(lonefrenquency * d))) })
                    .radius((d) => { return (11 + 4.5 * Math.abs(Math.cos(lonefrenquency * d))) })
                var sinewave = d3v5.select('#node0-' + temp.index);

                sinewave.append('g')
                    .attr("transform", "translate(0,0)")
                    .append('path')
                    .attr('d', line0(angles0))
                    .attr("stroke", function ()
                    {
                        return Colorsinepannel[1];
                    })
                    .attr("stroke-width", 1.2)
                    .attr("fill", "none")
                    .attr('id', function() {
                        return 'wave-1';
                    })
                    .on("mousemove",function(d, o){
                        //console.log(d);

                        divinner.style("display","none");

                        divinner.html("Aged Female:"+ d.columns[10].columnvalue +"</br> Percentage:"+ (d.columns[12].columnvalue).toFixed(3)  +"</br>")
                            .style("left", (d3v5.event.pageX+12) + "px")
                            .style("top", (d3v5.event.pageY-10) + "px")
                            .style("opacity", 0.8)
                            .style("display","block");
                        //console.log(d);

                        d3.selectAll('#wave-1')
                            .style("opacity", 1)
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            if (examplepieclickflag[a] == 1)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke)
                                    .style("stroke", "black")
                            }

                        }

                        for (var a = 0 ; a < rankingfemalenumber.length; a++)
                        {

                            d3.select('#text-'+ rankingfemalenumber[a].index)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + rankingfemalenumber[a].index)
                                .text('#' + (a + 1))
                                .style("font-size", "7px");
                        }



                    })
                    .on("mouseout",function(){
                        divinner.html(" ")
                            .style("display","none");
                        d3.selectAll('#wave-1')
                            .style("opacity", 0)
                        // node.each(function(d,o) {
                        //     d3.selectAll('#text-' + o)
                        //         .attr("dy", "0.35em")
                        //         .style("font-size", "5px")
                        //         .style('opacity', 1);
                        //     d3.select('#textranking-' + o)
                        //         .text([])
                        // })

                        div.html(" ").style("display","none");
                        //console.log(exampleclickflag);
                        if (exampleclickflag == 1) //whether clicked filter button
                        {
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                //console.log(examplepieclickflag[a]);
                                if (examplepieclickflag[a] == 0)
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", highlight_trans)
                                        .style("stroke", "white");

                            }
                            // //  如果不相连，将所有节点的透明度置为0.1
                            // d3.select('#node-' + o.index)
                            //     .selectAll('path')
                            //     .style("opacity", highlight_trans)

                        }
                        else{
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                if (examplepieclickflag[a] == 0)
                                {
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", 1)
                                        .style("stroke", "white");
                                }

                            }
                            //for (var c = 0 ; c < legendtempdata.length; c++)
                            for (var c = 0 ; c < clickcircle0flag.length; c++)
                            {

                                d3.selectAll('#text-' + c)
                                    .attr("dy", "0.35em")
                                    .style("font-size", function (){
                                        if (clickcircle0flag[c] == 1)
                                        {
                                            return "7px";
                                        }
                                        else
                                        {
                                            return "5px"
                                        }
                                    })
                                    .style('opacity', 1);
                                d3.select('#textranking-' + c)
                                    .text([])
                            }
                        }

                        //console.log(sumupcases);

                        if (ranksavingwordsafterselect.length > 0){
                            for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                            {
                                d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                                    .attr("dy", "-0.35em")
                                    .style("font-size", "7px");

                                d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                                    .text(ranksavingwordsafterselect[t].content)
                                    .style("font-size", "7px");
                            }
                        }


                    });

                sinewave.append('g')
                    .attr("transform", "translate(0,0)")
                    .append('path')
                    .attr('d', line1(angles1))
                    .attr("stroke", function ()
                    {
                        return Colorsinepannel[0];
                    })
                    .attr("stroke-width", 1.2)
                    .attr("fill", "none")
                    .attr('id', function() {
                        return 'wave-2';
                    })
                    .on("mousemove",function(d, o){
                        //console.log(d);

                        divinner.style("display","none");

                        divinner.html("Aged Male:"+ d.columns[11].columnvalue +"</br> Percentage:"+ (d.columns[13].columnvalue).toFixed(3)  +"</br>")

                            .style("left", (d3v5.event.pageX+12) + "px")
                            .style("top", (d3v5.event.pageY-10) + "px")
                            .style("opacity", 0.8)
                            .style("display","block");
                        //console.log(d);

                        d3.selectAll('#wave-2')
                            .style("opacity", 1)
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            if (examplepieclickflag[a] == 1)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke)
                                    .style("stroke", "black")
                            }
                        }
                        for (var a = 0 ; a < rankingmalenumber.length; a++)
                        {

                            d3.select('#text-'+ rankingmalenumber[a].index)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + rankingmalenumber[a].index)
                                .text('#' + (a + 1))
                                .style("font-size", "7px");
                        }


                    })
                    .on("mouseout",function(){
                        divinner.html(" ")
                            .style("display","none");
                        d3.selectAll('#wave-2')
                            .style("opacity", 0)
                        // node.each(function(d,o) {
                        //     d3.selectAll('#text-' + o)
                        //         .attr("dy", "0.35em")
                        //         .style("font-size", "5px")
                        //         .style('opacity', 1);
                        //     d3.select('#textranking-' + o)
                        //         .text([])
                        // })


                        div.html(" ").style("display","none");
                        //console.log(exampleclickflag);
                        if (exampleclickflag == 1) //whether clicked filter button
                        {
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                //console.log(examplepieclickflag[a]);
                                if (examplepieclickflag[a] == 0)
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", highlight_trans)
                                        .style("stroke", "white");

                            }
                            // //  如果不相连，将所有节点的透明度置为0.1
                            // d3.select('#node-' + o.index)
                            //     .selectAll('path')
                            //     .style("opacity", highlight_trans)

                        }
                        else{
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                if (examplepieclickflag[a] == 0)
                                {
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", 1)
                                        .style("stroke", "white");
                                }

                            }
                            for (var c = 0 ; c < clickcircle0flag.length; c++)
                            {

                                d3.selectAll('#text-' + c)
                                    .attr("dy", "0.35em")
                                    .style("font-size", function (){
                                        if (clickcircle0flag[c] == 1)
                                        {
                                            return "7px";
                                        }
                                        else
                                        {
                                            return "5px"
                                        }
                                    })
                                    .style('opacity', 1);
                                d3.select('#textranking-' + c)
                                    .text([])
                            }
                        }

                        //console.log(sumupcases);

                        if (ranksavingwordsafterselect.length > 0){
                            for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                            {
                                d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                                    .attr("dy", "-0.35em")
                                    .style("font-size", "7px");

                                d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                                    .text(ranksavingwordsafterselect[t].content)
                                    .style("font-size", "7px");
                            }
                        }

                    });

                sinewave.append('g')
                    .attr("transform", "translate(0,0)")
                    .append('path')
                    .attr('d', line2(angles2))
                    .attr("stroke", function ()
                    {
                        return Colorsinepannel[2];
                    })
                    .attr("stroke-width", 1.2)
                    .attr("fill", "none")
                    .attr('id', function(d, o) {
                        return 'wave-3';
                    })
                    .on("mousemove",function(d, o){
                        //console.log(d);

                        divinner.style("display","none");

                        divinner.html("The Lower Income:"+ d.columns[14].columnvalue +"</br> Percentage:"+ (d.columns[15].columnvalue).toFixed(3)  +"</br>")

                            .style("left", (d3v5.event.pageX+12) + "px")
                            .style("top", (d3v5.event.pageY-10) + "px")
                            .style("opacity", 0.8)
                            .style("display","block");
                        //console.log(d);

                        d3.selectAll('#wave-3')
                            .style("opacity", 1)
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            if (examplepieclickflag[a] == 1)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke)
                                    .style("stroke", "black")
                            }

                        }
                        for (var a = 0 ; a < rankingpovertynumber.length; a++)
                        {

                            d3.select('#text-'+ rankingpovertynumber[a].index)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + rankingpovertynumber[a].index)
                                .text('#' + (a + 1))
                                .style("font-size", "7px");
                        }
                    })
                    .on("mouseout",function(){
                        divinner.html(" ")
                            .style("display","none");
                        d3.selectAll('#wave-3')
                            .style("opacity", 0)
                        // node.each(function(d,o) {
                        //     d3.selectAll('#text-' + o)
                        //         .attr("dy", "0.35em")
                        //         .style("font-size", "5px")
                        //         .style('opacity', 1);
                        //     d3.select('#textranking-' + o)
                        //         .text([])
                        // })


                        div.html(" ").style("display","none");
                        //console.log(exampleclickflag);
                        if (exampleclickflag == 1) //whether clicked filter button
                        {
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                //console.log(examplepieclickflag[a]);
                                if (examplepieclickflag[a] == 0)
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", highlight_trans)
                                        .style("stroke", "white");

                            }
                            // //  如果不相连，将所有节点的透明度置为0.1
                            // d3.select('#node-' + o.index)
                            //     .selectAll('path')
                            //     .style("opacity", highlight_trans)

                        }
                        else{
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                if (examplepieclickflag[a] == 0)
                                {
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", 1)
                                        .style("stroke", "white");
                                }

                            }
                            for (var c = 0 ; c < clickcircle0flag.length; c++)
                            {

                                d3.selectAll('#text-' + c)
                                    .attr("dy", "0.35em")
                                    .style("font-size", function (){
                                        if (clickcircle0flag[c] == 1)
                                        {
                                            return "7px";
                                        }
                                        else
                                        {
                                            return "5px"
                                        }
                                    })
                                    .style('opacity', 1);
                                d3.select('#textranking-' + c)
                                    .text([])
                            }
                        }

                        //console.log(sumupcases);

                        if (ranksavingwordsafterselect.length > 0){
                            for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                            {
                                d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                                    .attr("dy", "-0.35em")
                                    .style("font-size", "7px");

                                d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                                    .text(ranksavingwordsafterselect[t].content)
                                    .style("font-size", "7px");
                            }
                        }

                    });

                sinewave.append('g')
                    .attr("transform", "translate(0,0)")
                    .append('path')
                    .attr('d', line3(angles3))
                    .attr("stroke", function ()
                    {
                        return Colorsinepannel[3];
                    })
                    .attr("stroke-width", 1.2)
                    .attr("fill", "none")
                    .attr('id', function(d, o) {
                        return 'wave-4';
                    })
                    .on("mousemove",function(d, o){
                        //console.log(d);

                        divinner.style("display","none");

                        divinner.html("Lone person:"+ d.columns[16].columnvalue +"</br> Percentage:"+ (d.columns[17].columnvalue).toFixed(3)  +"</br>")

                            .style("left", (d3v5.event.pageX+12) + "px")
                            .style("top", (d3v5.event.pageY-10) + "px")
                            .style("opacity", 0.8)
                            .style("display","block");
                        //console.log(d);

                        d3.selectAll('#wave-4')
                            .style("opacity", 1)
                        for (var a = 0; a < examplepieclickflag.length; a++)
                        {
                            if (examplepieclickflag[a] == 1)
                            {
                                d3.selectAll('#piebar-' + a)
                                    .style("opacity", 1)
                                    .style("stroke-width", nominal_stroke)
                                    .style("stroke", "black")
                            }

                        }

                        for (var a = 0 ; a < rankinglonenumber.length; a++)
                        {

                            d3.select('#text-'+ rankinglonenumber[a].index)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");

                            d3.select('#textranking-' + rankinglonenumber[a].index)
                                .text('#' + (a + 1))
                                .style("font-size", "7px");
                        }
                    })
                    .on("mouseout",function(){
                        divinner.html(" ")
                            .style("display","none");
                        d3.selectAll('#wave-4')
                            .style("opacity", 0)
                        // node.each(function(d,o) {
                        //     d3.selectAll('#text-' + o)
                        //         .attr("dy", "0.35em")
                        //         .style("font-size", "5px")
                        //         .style('opacity', 1);
                        //     d3.select('#textranking-' + o)
                        //         .text([])
                        // })


                        div.html(" ").style("display","none");
                        //console.log(exampleclickflag);
                        if (exampleclickflag == 1) //whether clicked filter button
                        {
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                //console.log(examplepieclickflag[a]);
                                if (examplepieclickflag[a] == 0)
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", highlight_trans)
                                        .style("stroke", "white");

                            }
                            // //  如果不相连，将所有节点的透明度置为0.1
                            // d3.select('#node-' + o.index)
                            //     .selectAll('path')
                            //     .style("opacity", highlight_trans)

                        }
                        else{
                            for (var a = 0; a < examplepieclickflag.length; a++)
                            {
                                if (examplepieclickflag[a] == 0)
                                {
                                    d3.selectAll('#piebar-' + a)
                                        .style("stroke-width", 0)
                                        .style("opacity", 1)
                                        .style("stroke", "white");
                                }

                            }
                            for (var c = 0 ; c < clickcircle0flag.length; c++)
                            {

                                d3.selectAll('#text-' + c)
                                    .attr("dy", "0.35em")
                                    .style("font-size", function (){
                                        if (clickcircle0flag[c] == 1)
                                        {
                                            return "7px";
                                        }
                                        else
                                        {
                                            return "5px"
                                        }
                                    })
                                    .style('opacity', 1);
                                d3.select('#textranking-' + c)
                                    .text([])
                            }
                        }

                        //console.log(sumupcases);

                        if (ranksavingwordsafterselect.length > 0){
                            for (var t = 0 ; t < ranksavingwordsafterselect.length; t++)
                            {
                                d3.select('#text-'+ ranksavingwordsafterselect[t].id)
                                    .attr("dy", "-0.35em")
                                    .style("font-size", "7px");

                                d3.select('#textranking-' + ranksavingwordsafterselect[t].id)
                                    .text(ranksavingwordsafterselect[t].content)
                                    .style("font-size", "7px");
                            }
                        }


                    });

                //console.log(sinewave);
            }

        });


        //console.log(testdata);

        var circle = node.append("path")
            .attr('class', "circle")
            .attr("d", d3.svg.symbol()
                .size(2400))
            .attr('id', function(d, i) {
                return 'circle-' + d.index
            })
            // .size(function(d) { return Math.PI*Math.pow(size(d.size)||nominal_base_node_size,2); }))
            // .type(function(d) { return d.type; }))

            // .style(tocolor, 'white')
            // .style('fill-opacity', 0)

            //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
            .style("stroke-width", nominal_stroke)
            .style(towhite, "black")
            .style("stroke-opacity", 0.8)

            .style('fill', 'none')

            .on("mousemove",function(d){
                // console.log(d.data);
                // var mouseVal = d3.mouse(this);
                // var tempscore;
                // divinner.style("display","none");
                // // divinner.html("LGA:"+ d.id +"</br>"+d.columns[0].columnname+": "+d.columns[0].columnvalue+"</br>"
                // //     +d.columns[1].columnname+": "+d.columns[1].columnvalue+"</br>"
                // //     +d.columns[2].columnname+": "+d.columns[2].columnvalue+"</br>"
                // //     +d.columns[3].columnname+": "+d.columns[3].columnvalue+"</br>"
                // //     +d.columns[4].columnname+": "+d.columns[4].columnvalue)
                // divinner.html("LGA:"+ d.id +"</br>"+d.columns[0].columnname+": "+d.columns[0].columnvalue+"</br>")
                //
                //     .style("left", (d3.event.pageX+12) + "px")
                //     .style("top", (d3.event.pageY-10) + "px")
                //     .style("opacity", 0.8)
                //     .style("display","block");
                //console.log(d);

            })
            .on("mouseout",function(){
                // divinner.html(" ").style("display","none");
            });



        var circle0 = node.append("path")
            .attr('class', "circle")
            .attr("d", d3.svg.symbol()
                .size(300))
            // .size(function(d) { return Math.PI*Math.pow(size(d.size)||nominal_base_node_size,2); }))
            // .type(function(d) { return d.type; }))
            .attr('id', function(d, i) {
                //console.log(d);
                return "circle0-" + d.id;
            })
            .style(tocolor, 'white')
            .style('fill-opacity', 1)
            //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
            .style("stroke-width", nominal_stroke)
            .style(towhite, "black")
            .style("stroke-opacity", 0.1)
            .on("mousemove",function(d){
                // console.log(d.data);
                // var mouseVal = d3.mouse(this);
                // var tempscore;
                divinner.style("display","none");

                //highlight whether circle0 been clicked or not
                //fill with non color in other components

                for (var a = 0; a < examplepieclickflag.length; a++)
                {
                    if (examplepieclickflag[a] == 1)
                    {
                        d3.selectAll('#piebar-' + a)
                            .style("opacity", 1)
                            .style("stroke-width", nominal_stroke)
                            .style("stroke", "black")
                    }
                    else{
                        d3.selectAll('#piebar-' + a)
                            .style("opacity", highlight_trans)
                    }

                }



                //console.log(legendtempdata);
                // console.log(exampleclickflag);
                //if did not filter button then display the total cases number in center of circle in whole period
                if (exampleclickflag == 0)
                {
                    for (var c = 0 ; c < legendtempdata.length; c++)
                    {
                        var totalcasesforeach = 0;
                        for (var d = 0; d < legendtempdata[c].proportions.length; d++)
                        {
                            totalcasesforeach += legendtempdata[c].proportions[d].cases;
                        }

                        if (clickfilterflag == 0) // whether click filter button, means need to display total cases in textranking
                        {
                            d3.selectAll('#text-'+ c)
                                .attr("dy", "-0.35em")
                                .style("font-size", "7px");
                            d3.selectAll('#textranking-'+ c)
                                .text(totalcasesforeach);
                        }
                    }
                }
                else
                    //if click filter button means filtering weeks then display in x/total format in center of circle
                {
                    //console.log(sumupcases);
                    for (var c = 0 ; c < legendtempdata.length; c++)
                    {
                        var totalcasesforeach = 0;
                        for (var d = 0; d < legendtempdata[c].proportions.length; d++)
                        {
                            totalcasesforeach += legendtempdata[c].proportions[d].cases;
                        }
                        for (var i = 0; i < sumupcases.length; i++)
                        {
                            if (legendtempdata[c].index == sumupcases[i].origin)
                                d3.selectAll('#textranking-'+ sumupcases[i].origin)
                                    .text(sumupcases[i].value + '/' + totalcasesforeach);
                        }
                        //console.log(sumupcasesnotstated);
                        if (legendtempdata[c].index == sumupcasesnotstated[0].origin)
                            d3.selectAll( '#textranking-'+ sumupcasesnotstated[0].origin)
                                .text(sumupcasesnotstated[0].value + '/' + totalcasesforeach);
                        d3.selectAll('#text-'+ c)
                            .attr("dy", "-0.35em")
                            .style("font-size", "7px");


                    }


                }
                //console.log(legendtempdata);


                for (var c = 0 ; c < legendtempdata.length; c++)
                {
                    if (clickcircle0flag[c] == 1)
                        d3.select('#circle0-' + legendtempdata[c].id)
                            .style("opacity",1);

                }
                if (nodeclickedflag4parallel == 1){
                    for (var c = 0 ; c < legendtempdata.length; c++)
                    {
                        //console.log(legendtempdata);
                        if ((clickcircle0flag[c] == 1) && (legendtempdata[c].id != d.id))
                        {
                            var totalcasesforeach = 0;
                            for (var d = 0; d < legendtempdata[c].proportions.length; d++)
                            {
                                totalcasesforeach += legendtempdata[c].proportions[d].cases;
                            }
                            d3.select("#path-" + legendtempdata[c].id)
                                .style("opacity", 0.9)
                                .style("stroke-width",2)
                                .style("stroke-dasharray", (totalcasesforeach/6)) // make the stroke dashed;

                        }
                        else if ((clickcircle0flag[c] == 1) && (legendtempdata[c].id == d.id))
                        {
                            d3.select("#path-" + legendtempdata[c].id)
                                .style("opacity", 0.9)
                                .style("stroke-width",3)
                        }
                        else
                        {
                            d3.select("#path-" + legendtempdata[c].id)
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }

                    }
                    d3.select("#path-" + d.id)
                        .style("opacity", 1)
                        .style("stroke-width",3)
                        .style("fill-color", GreyScale[1]);

                    parallelforstore.push(d.id);

                    d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                        .orient('right')
                        .tickValues(parallelforinteraction.map(function(p) {
                            for (var a = 0; a < parallelforstore.length; a++)
                            {
                                if (parallelforstore[a] == p["LGA_code"])
                                    return p["LGA_Name"];
                            }
                        })));
                }
                parallelforstore = uniquearr(parallelforstore);
                //console.log(parallelforstore);


                // console.log(d3.select(this).style('fill'));

            })
            .on("mouseout",function(d) {
                divinner.html(" ").style("display", "none");
                // if (parallelforstore.length > 1)
                // {
                //     parallelforstore.pop();
                //     console.log(parallelforstore);
                // }
                for (var c = 0 ; c < legendtempdata.length; c++)
                {
                    if (clickcircle0flag[c] == 0) // whether click
                    {
                        d3.selectAll('#text-'+ c)
                            .attr("dy", ".35em")
                            .style("font-size", "5px");
                        d3.selectAll('#textranking-'+ c)
                            .text([]);
                    }
                    else
                    {
                        var totalcasesforeach = 0;
                        for (var d = 0; d < legendtempdata[c].proportions.length; d++)
                        {
                            totalcasesforeach += legendtempdata[c].proportions[d].cases;
                        }
                        d3.select("#path-" + legendtempdata[c].id)
                            .style("opacity", 0.9)
                            .style("stroke-width",2)
                            .style("stroke-dasharray", (totalcasesforeach/6)) // make the stroke dashed;
                        d3.selectAll('#text-'+ c)
                            .attr("dy", ".35em")
                            .style("font-size", "7px");
                        d3.selectAll('#textranking-'+ c)
                            .text([]);

                    }

                }

                if (nodeclickedflag4parallel == 1){
                    // console.log(legendtempdata);
                    for (var c = 0 ; c < legendtempdata.length; c++)
                    {
                        if ((legendtempdata[c].id == d.id)&&(clickcircle0flag[c] == 0))
                            parallelforstore.pop();
                    }
                    //console.log(parallelforstore);

                    for (var c = 0 ; c < legendtempdata.length; c++)
                    {
                        if (clickcircle0flag[c] == 1)
                        {
                            d3.select("#path-" + legendtempdata[c].id)
                                .style("opacity", 0.9)
                                .style("stroke-width",2)
                                .style("fill-color", GreyScale[0]);

                        }
                        else
                        {
                            d3.select("#path-" + legendtempdata[c].id)
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }

                    }
                    d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                        .orient('right')
                        .tickValues(parallelforinteraction.map(function(p) {
                            for (var a = 0; a < parallelforstore.length; a++)
                            {
                                if (parallelforstore[a] == p["LGA_code"])
                                    return p["LGA_Name"];
                            }
                        })));

                }

            })

            .on('click',function(d,o){
                if (d3.event.defaultPrevented) {
                    return;
                }
                nodeclickedflag4parallel = 1;

                // d3.select(this).style('fill',"#BC8F8F").style("opacity", 1);
                d3.select(this).style('fill',GreyScale[0]).style("opacity", 1);
                // d3.select(this).style('fill',ColorBrown[9]).style("fill-opacity", 0.75);
                d3.select('#text-'+ o).style("font-size", "7px");

                //console.log(o);

                //click count in circle0
                clickcircle0flag[o] = 1;
                // console.log(clickcircle0flag);
                // console.log(d3.select(this));
                var templgacode = [];
                //copyevent
                for (var c = 0 ; c < legendtempdata.length; c++)
                {
                    if (clickcircle0flag[c] == 1)
                    {
                        d3.select('#circle0-' + legendtempdata[c].id)
                            .style("opacity",1);
                        templgacode.push(legendtempdata[c].id);

                    }

                }

                //parallel interaction begins
                // console.log(d);
                parallelforstore.push(d.id);

                d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                    .orient('right')
                    .tickValues(parallelforinteraction.map(function(p) {
                        for (var a = 0; a < parallelforstore.length; a++)
                        {
                            if (parallelforstore[a] == p["LGA_code"])
                                return p["LGA_Name"];
                        }
                    })));


                for (var i = 0; i < parallelforinteraction.length; i++)
                {
                    for (var a = 0; a < parallelforstore.length; a++)
                    {
                        if (parallelforinteraction[i]["LGA_code"] != parallelforstore[a])
                        {
                            d3.select("#path-" + parallelforinteraction[i]["LGA_code"])
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }
                        d3.select("#path-" + parallelforstore[a])
                            .style("opacity", 0.9)
                            .style("stroke-width",2);

                    }

                }


                //parallel interaction ends

                //waiting for map interaction
                //console.log(PCglobal.features);

                clickcircle0formap = [];
                for (var i = 0; i < PCglobal.features.length; i++) {
                    for (var j = 0; j < templgacode.length; j++)
                    {
                        if (templgacode[j] == PCglobal.features[i].properties.LGAcode)
                        {
                            clickcircle0formap.push(PCglobal.features[i]);
                        }
                    }
                }

                tempmapdata0 = {};

                if (clickcircle0formap.length > 0)
                {
                    tempmapdata0 = {
                        "features" : clickcircle0formap,
                        "type": "FeatureCollection"
                    };
                }
                //console.log(tempmapdata0);


                if (newcircleclick == 0)
                {
                    //console.log(newcircleclick);
                    map.addSource('Circle0selected', {
                        "type":"geojson",
                        "data": tempmapdata0
                    });
                    map.addLayer({
                        "id": "Circle0selectedArea",
                        "type": "fill",
                        "source": "Circle0selected",
                        'paint': {
                            'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', "Uptodateselected"],
                                0, '#eeefef',
                                // 5, "#d53e4f",
                                // 25, "#b8313e",
                                // 50, "#9c252f",
                                // 75, "#801820",
                                // 100, "#660b13",
                                // 1000, "#4d0000"
                                100,RedScale6redinmiddle[0],
                                300, RedScale6redinmiddle[1],
                                500, RedScale6redinmiddle[2],
                                800, RedScale6redinmiddle[3],
                                1500, RedScale6redinmiddle[4],
                                1600, RedScale6redinmiddle[5]
                            ],
                            'fill-opacity': 0.95
                        }
                    }, "Postcode");

                    map.addLayer({
                        "id": "Circle0selected",
                        "type": "line",
                        "source": "Circle0selected",

                        "paint": {
                            "line-color": GreyScale[1],
                            //"line-color": ColorBrown[9],
                            "line-width": 1.5
                        },
                        'fill-opacity': 1
                    });

                    newcircleclick = 1;
                }


                // map.getSource('Postcode').setData(PCglobal);
                //map.getSource('Circleclicked').setData(tempmapdata0);
                map.getSource('Postcode').setData(PCglobal);
                map.setPaintProperty('PostcodeCases','fill-opacity', 0);
                map.setPaintProperty('Postcode','line-color', GreyScale[0]);
                map.setPaintProperty('Postcode',"line-width", 0.8);

                map.getSource('Circle0selected').setData(tempmapdata0);

                // map.setPaintProperty('NodeselectedArea','fill-opacity', 0.95);




            })



            .on('dblclick',function(d,o){
                if (d3.event.defaultPrevented) {
                    return;
                }
                clickcircle0flag[o] = 0;
                d3.select(this).style('fill','white').style("opacity", 1);
                //alert('dblclick circle0');
                d3.select('#text-'+ o).style("font-size", "5px");

                // console.log(d);
                // console.log(parallelforstore);

                var tempfilterlgaarr = [];
                for (var i = 0; i <parallelforstore.length; i++)
                {
                    if (parallelforstore[i] != d.id)
                    {
                        tempfilterlgaarr.push(parallelforstore[i]);
                    }
                }


                d3.select('#paxis-name').call(axis.scale(y["LGA_Name"])
                    .orient('right')
                    .tickValues(parallelforinteraction.map(function(p) {
                        for (var a = 0; a < tempfilterlgaarr.length; a++)
                        {
                            if (tempfilterlgaarr[a] == p["LGA_code"])
                                return p["LGA_Name"];
                        }
                    })));


                for (var i = 0; i < parallelforinteraction.length; i++)
                {
                    for (var a = 0; a < tempfilterlgaarr.length; a++)
                    {
                        if (parallelforinteraction[i]["LGA_code"] != tempfilterlgaarr[a])
                        {
                            d3.select("#path-" + parallelforinteraction[i]["LGA_code"])
                                .style("opacity", 0)
                                .style("stroke-width",0.4);
                        }
                        d3.select("#path-" + tempfilterlgaarr[a])
                            .style("opacity", 1)
                            .style("stroke-width",2);

                    }

                }



            });

        node.append("svg:text")
            //.attr("class", "nodetext")
            .attr("font-family", "sans-serif")
            .attr("font-weight", 800)
            .attr("text-anchor", "middle")
            //居中
            .attr("dx", 0)
            .attr("dy", ".35em")
            .attr('id', function(d, i) {
                return 'text-' + d.index
            })
            .text(function(d) {
                //console.log(d);
                return d.idname ;
            })
            .style(tocolor, 'black')
            .style("font-size", "5px")
            .style("text-shadow", "0 2px 0 #FFF, 2px 0 0 #FFF, 0 -2px 0 #FFF, -2px 0 0 #FFF")
            .on("mousemove",function(d){
                d3.select(this).style("font-size", "7px");
                //console.log(d);
            })
            .on("mouseout",function(d,o){

                if (exampleclickflag == 0) //whether clicked filter button

                    // div.html(" ").style("display","none");
                    // d3.select(this).style("font-size", "5px");
                    for (var c = 0 ; c < clickcircle0flag.length; c++)
                    {

                        d3.selectAll('#text-' + c)
                            .attr("dy", "0.35em")
                            .style("font-size", function (){
                                if (clickcircle0flag[c] == 1)
                                {
                                    return "7px";
                                }
                                else
                                {
                                    return "5px"
                                }
                            })
                            .style('opacity', 1);
                        d3.select('#textranking-' + c)
                            .text([])
                    }

            })
            .on("click", nodeclick)
            .on("dblclick", dblclick);

        node.append("svg:text")
            //.attr("class", "nodetext")
            .attr("font-family", "sans-serif")
            .attr("font-weight", 1200)
            .attr("text-anchor", "middle")
            //居中
            .attr("dx", 0)
            .attr("dy", ".7em")
            .attr('id', function(d, i) {
                return 'textranking-' + d.index
            })
            .text([])
            .style(tocolor, 'black')
            .style("text-shadow", "0 2px 0 #FFF, 2px 0 0 #FFF, 0 -2px 0 #FFF, -2px 0 0 #FFF")


        var text = g.selectAll(".text")

            // .data(graph.nodes)
            .data([])
            //.data(testdata)
            .enter().append("text")

            // .attr("dx", -10)
            // .attr("dy", ".35em")
            .style("font-size", nominal_text_size + "px");

        //console.log(testdata);

        if (text_center)
            text.text(function(d) {
                if (typeof(d.id) !== 'undefined') {
                    return d.id;
                }
            })
                .style("text-anchor", "middle");
        else
            text.attr("dx", function(d) {return (size(d.size)||nominal_base_node_size);})
                .text(function(d) {
                    if (typeof(d.id) !== 'undefined') {
                        return '\u2002'+d.id;
                    }
                });



        node.on("mouseover", function(d) {
            set_highlight(d);
        })
            .on("mousedown", function(d) { d3.event.stopPropagation();
                //console.log(d);
                focus_node = d;
                set_focus(d);
                if (highlight_node === null) set_highlight(d)

            })
            .on("mouseout", function(d) {
                node.each(function(o) {
                    d3.select('#node-' + o.index)
                        .selectAll('path')
                        .style("opacity", 1);
                });
                exit_highlight();

            });

        d3.select(window).on("mouseup",
            function() {
                if (focus_node!==null)
                {
                    focus_node = null;
                    if (highlight_trans<1)
                    {
                        //piesymbol.style("opacity", 1);
                        circle.style("opacity", 1);
                        text.style("opacity", 1);
                        link.style("opacity", 1);
                        //拖拽结束后的透明度变化
                    }
                }

                if (highlight_node === null) exit_highlight();
            });

        function exit_highlight()
        {
            highlight_node = null;
            if (focus_node===null)
            {
                svg.style("cursor","move");
                if (highlight_color!="white")
                {

                    // piesymbol.style(towhite, "white");
                    circle.style(towhite, "black");
                    text.style("font-weight", "normal");
                    link.style("stroke", function(o) {return (isNumber(o.cases) && o.cases>=0)?color(o.cases):default_link_color});
                }

            }
        }

        function set_focus(d)
        {
            var temparr = [];
            if (highlight_trans<1)  {

                //点击拖拽时响应
                //拖拽时循环数据中link部分，是否有链接
                // console.log(d3.event.subject);
                // // alert('1');
                // piesymbol.style("opacity", function(o) {
                //     // console.log(d);
                //     // console.log(o.data.ancestor);
                //
                //     return isConnected(d, o) ? 0.5 : 0.1;
                //
                // });
                // node.each(function(o) {
                //     if(isConnected2(d, o)) {
                //         //  如果相连，那么将所有的节点的透明度置为1
                //         d3.select('#node-' + o.index)
                //             .selectAll('path')
                //             .style("opacity", 1)
                //     } else {
                //         //  如果不相连，将所有节点的透明度置为0.1
                //         d3.select('#node-' + o.index)
                //             .selectAll('path')
                //             .style("opacity", highlight_trans)
                //     }
                // });


                text.style("opacity", function(o) {
                    // console.log(isConnected(d, o));
                    temparr.push(isConnected(d, o));
                    return isConnected(d, o) ? 1 : highlight_trans;
                });


                link.style("opacity", function(o) {
                    return o.source.index == d.index || o.target.index == d.index ? 1 : highlight_trans;
                });
            }
        }


        function set_highlight(d)
        {
            svg.style("cursor","pointer");
            if (focus_node!==null) d = focus_node;
            highlight_node = d;
            //console.log(highlight_node);

            if (highlight_color!="white")
            {

                node.each(function(o) {
                    if(isConnected2(d, o)) {
                        //  如果相连，那么将所有的节点的透明度置为1
                        d3.select('#node-' + o.index)
                            .selectAll('path')
                            .style("opacity", 1)
                    } else {
                        //  如果不相连，将所有节点的透明度置为0.1
                        d3.select('#node-' + o.index)
                            .selectAll('path')
                            //.style("opacity", 1)
                            .style("opacity", highlight_trans)

                        circle.style("opacity", 1)
                            .style("stroke-width", nominal_stroke)
                            .style(towhite, "black")
                    }
                });

                // piesymbol.style(towhite, function(o) {
                //     return isConnected(d, o) ? highlight_color : "white";});

                circle.style("towhite", function(o) {
                    return isConnected(d, o) ? highlight_color : "black";});
                text.style("font-weight", function(o) {
                    return isConnected(d, o) ? "bold" : "normal";});
                link.style("stroke", function(o) {
                    return o.source.index == d.index || o.target.index == d.index ? highlight_color : ((isNumber(o.cases) && o.cases>=0)?color(o.cases):default_link_color);

                });
            }
        }




        zoom.on("zoom", function() {

            var stroke = nominal_stroke;
            if (nominal_stroke*zoom.scale()>max_stroke) stroke = max_stroke/zoom.scale();
            link.style("stroke-width", function(o) {
                return o.width *zoom.scale();
            });

            circle.style("stroke-width",stroke);

            var base_radius = nominal_base_node_size;
            if (nominal_base_node_size*zoom.scale()>max_base_node_size) base_radius = max_base_node_size/zoom.scale();
            circle.attr("d", d3.svg.symbol()
                .size(2400)
                .type(function(d) { return d.type; }));


            //circle.attr("r", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); })
            if (!text_center) text.attr("dx", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); });

            var text_size = nominal_text_size;
            if (nominal_text_size*zoom.scale()>max_text_size) text_size = max_text_size/zoom.scale();
            text.style("font-size",text_size + "px");

            g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        });

        svg.call(zoom).on("dblclick.zoom", null);

        resize();
        //window.focus();

        force.on("tick", function() {

            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
            text.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });


        });

        function resize() {
            //var o = document.getElementById("graphtop-left")
            // var width = window.innerWidth, height = window.innerHeight;
            var div = document.getElementById("newflower");
            var width = div.clientWidth;    // 返回元素的总宽度
            var height = div.clientHeight;    // 返回元素的总高度
            //console.log(width);
            //console.log(height);
            svg.attr("width", width).attr("height", height);

            force.size([force.size()[0]+(width-w)/zoom.scale(),force.size()[1]+(height-h)/zoom.scale()]).resume();
            w = width;
            h = height;
        }


        //MAP BEGINS


        // Capture Radio Button Click Event


        map.on('load',function(){

            var canvas = map.getCanvasContainer();

            // Variable to hold the starting xy coordinates
            // when `mousedown` occured.
            var start;

            // Variable to hold the current xy coordinates
            // when `mousemove` or `mouseup` occurs.
            var current;

            // Variable for the draw box element.
            var box;

            var layers = map.getStyle().layers;
// Find the index of the first symbol layer in the map style
            var firstSymbolId;
            for (var i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol'&& layers[i].layout['text-field']) {
                    firstSymbolId = layers[i].id;
                    break;
                }
            }


            // GeoCode Code - Mapbox Default GeoCoder (Paid Service)

            var geocoder = map.addControl(
                new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    mapboxgl: mapboxgl,
                    country: 'au', // limit results to Australia
                    placeholder: ' Search Postcode, Suburb',
                    bbox: [139.965, -38.030, 155.258, -27.839], // limit to geographic bounds of NSW
                    type: ['region','postcode'],
                    limit: 100,
                    filter: function (item) {
                        if(!item.context){
                            return item;
                        }
                        if(item.context.length <= 4){
                            return item.context.map(function (i) {
                                // id is in the form {index}.{id} per https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                                // this example attempts to find the `region` named `New South Wales`
                                return (i.id.split('.').shift() === 'region' && i.text === 'New South Wales');
                            }).reduce(function (acc, cur) {
                                console.log(acc)
                                return acc || cur;
                            });
                        }

                    },

                })
            );


            // Add Navigation Control

            map.addControl(new mapboxgl.NavigationControl({
                showCompass: false
            }));

            // map.addControl(new mapboxgl.AttributionControl({
            //      compact: true
            //
            // }))

            // Popup Initialization

            var hoverPopup = new mapboxgl.Popup({
                closeButton: false
            });

            //var PostCode;

            // Read NSW Postcodes GeoJSON

            $.getJSON('datafiles/nsw_lga_polygon_V5.geojson',function(geojson){
                console.log(Mapdatafromstaweektable);
                console.log(geojson);
                getMapdata(geojson,[],0);
            })

        })


        //MAP ENDS


        function isNumber(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }

        //uniquearr
        function Uniquearr(arr){
            if(!Array.isArray(arr)){
                console.log('type error')
                return;
            }
            arr = arr.sort()
            var temparray = [arr[0]];
            for (var i=1; i < arr.length; i++){
                if (arr[i] != arr[i-1]){
                    temparray.push(arr[i]);
                }
            }
            return temparray;

        }



    });

    function Filterdata(){
        exampleclickflag = 1;
        clickfilterflagForeachPetals = 1;
        console.log("Button Click");
        //reset
        sumupcases = [];
        sumupcasesnotstated = [];
        ranksavingwordsafterselect = [];

        // console.log(legendtempdata);
        // console.log(examplepieclickflag);

        for (var b = 0; b < legendtempdata.length; b ++) //for every node except notstated
        {
            var tempsumupcases = 0;
            for (var a = 0; a < examplepieclickflag.length; a++)
            {
                if (examplepieclickflag[a] == 0)
                    d3.selectAll('#piebar-' + a)
                        .style("stroke-width", 0)
                        .style("opacity", highlight_trans)
                        .style("stroke", "white");

                else if (examplepieclickflag[a] == 1)
                    //console.log(legendtempdata[b].proportions[a].cases);
                    //console.log(legendtempdata[b].proportions[a].cases);

                    tempsumupcases += legendtempdata[b].proportions[a].cases;

            }
            if (b < legendtempdata.length - 1)
            {
                sumupcases.push({
                    value : tempsumupcases,
                    index : b,
                    origin : b
                });
            }
            else{
                sumupcasesnotstated.push({
                    value : tempsumupcases,
                    index : b,
                    origin : b
                });
            }

        }

        //end for loop of exampleclick
        sumupcases.sort(sortRule);


        // console.log(sumupcases);
        // console.log(sumupcasesnotstated);

        let prevalue = 0;//预定义分数
        let ranking = 0;//排名

        sumupcases.forEach((item,index)=> {
            if (item.value == prevalue) {
                item.index = ranking;
            } else {
                ranking++;
                prevalue = item.value;
                item.index = ranking;
            }
        })
        savinglastsumupcases = sumupcases;

        //console.log(sumupcases);

        for (var c = 0 ; c < sumupcases.length; c++)
        {

            d3.select('#text-'+ sumupcases[c].origin)
                .attr("dy", "-0.35em")
                .style("font-size", "7px");

            d3.select('#textranking-' + sumupcases[c].origin)
                .text('#' + sumupcases[c].index)
                .style("font-size", "7px");
            ranksavingwordsafterselect.push({
                id: sumupcases[c].origin,
                content: '#' + sumupcases[c].index
            });

        }
        //console.log(sumupcases);

        //begin interaction with map
        // console.log(examplepieclickflag);
        //there is no time so that i just put continuous timeline here, will cause mistake when user dont select continuous time
        for (var aa = 0; aa<examplepieclickflag.length; aa++)
        {
            //console.log(datearray);
            if (examplepieclickflag[aa] == 1)
            {
                //stands for aa+1's week is selected
                datearrayselected.push(datearray[aa]);
                //console.log(datearray[aa]);

            }
        }

        // console.log(datearrayselected);
        // console.log(Mapdatafromstaweektable);

        for (var a = 0; a<datearrayselected.length; a++)
        {

            for (var k = 0; k < Mapdatafromstaweektable.length; k++) {
                //console.log(Mapdatafromstaweektable[k].Date);
                if (datearrayselected[a] == Mapdatafromstaweektable[k].Date)
                {
                    //stands for aa+1's week is selected

                    dataarrayselected.push(Mapdatafromstaweektable[k]);
                    //console.log(Mapdatafromstaweektable[k]);
                }
            }

        }


        //console.log(dataarrayselected);
        // console.log(Mapdatafromstaweektable);
        var tempdateselected = [];
        for (var l = 0; l < DictionaryLGAandSuburbs.length; l++)
        {
            var tempbegin = 0, tempend = 0;
            var tempdataarray = [];
            var casessum = 0;

            for (var k = 0; k < dataarrayselected.length; k++) {
                if (DictionaryLGAandSuburbs[l].LGAcode == dataarrayselected[k].LGAcode)
                {
                    casessum += dataarrayselected[k].Cases;
                    tempdataarray.push({
                        "Date" : dataarrayselected[k].Date,
                        "LGAcode" : dataarrayselected[k].LGAcode,
                        "LGAname" : dataarrayselected[k].LGAname,
                        //"POA_NAME16" : dataarrayselected[k].POA_NAME16
                        // "Cases":  dataarrayselected[k].Cases,
                        // "CasesUptonow" : 0

                    });
                }

            }
            //console.log(tempdataarray);
            if (tempdataarray.length > 0)
            {
                //console.log(tempdataarray);
                var startdatetemp = tempdataarray[0].Date;
                var enddatetemp = tempdataarray[tempdataarray.length - 1].Date;
                var startdate = startdatetemp.split("-");
                var enddate = enddatetemp.split("-");

                // var startrevisedateformat = startdate[0].slice(0,4) + "/" + startdate[0].slice(4,6) + "/" + startdate[0].slice(6,8);
                // var endrevisedateformat = enddate[1].slice(0,4) + "/" + enddate[1].slice(4,6) + "/" + enddate[1].slice(6,8);

                var startrevisedateformat = startdate[0];
                var endrevisedateformat = enddate[1];

                //console.log(finaldatestr);
                var finaldatestr = startrevisedateformat + " - " + endrevisedateformat;
                var datestring = document.getElementById("demo");
                datestring.innerHTML=finaldatestr;
                //
                // var finaldatestr = " " + startrevisedateformat + " - " + endrevisedateformat;

                // var tempcases =  tempdataarray[tempdataarray.length - 1].CasesUptonow - tempdataarray[0].CasesUptonow;

                tempdateselected.push({
                    "Date" : finaldatestr,
                    "LGAcode" : tempdataarray[0].LGAcode,
                    "LGAname" : tempdataarray[0].LGAname,
                    //"POA_NAME16" : tempdataarray[0].POA_NAME16,
                    // "Cases":  tempdataarray[0].Cases,
                    "CasesUptonow" : casessum

                });
            }

        }

        var tempdataforclicknode = [];
        console.log(tempdataarray);
        console.log(tempmapdata0); //postcode selected by highlighted circle0
        // console.log(tempdateselected); //all spots with selected date time
        // if (tempmapdata0.features.length > 0){
        if (JSON.stringify(tempmapdata0) != "{}"){
            for (var j = 0 ; j < tempmapdata0.features.length; j++)
            {
                for (var i =0; i < tempdateselected.length; i++)
                {
                    // console.log(tempmapdata0.features[j].properties.POA_NAME16);
                    // console.log(tempdateselected[i].POA_NAME16);
                    if (tempmapdata0.features[j].properties.POA_NAME16 == tempdateselected[i].POA_NAME16)
                    {

                        tempdataforclicknode.push(tempdateselected[i]);
                    }
                }
            }
        }

        //console.log(tempdataforclicknode);

        // console.log(tempdataarray);
        // console.log(finaldatestr);

        //console.log(tempdateselected);
        // console.log(PSglobal);

        // getMapdata(PSglobal,popglobal,1);
        for (var i = 0; i < PCglobal.features.length; i++)
        {
            if (newcircleclick == 0)
            {
                for (var j = 0; j < tempdateselected.length; j++)
                {

                    if (PCglobal.features[i].properties.lgacode == tempdateselected[j].LGAcode){
                        PCglobal.features[i].properties["interacteddate"] = tempdateselected[j].Date;

                        var tempjudge = tempdateselected[j].CasesUptonow;
                        // console.log(tempjudge);
                        PCglobal.features[i].properties["Realdata"] = tempjudge;
                        if(tempjudge <= 100 && tempjudge > 0){

                            PCglobal.features[i].properties["Totalcases"] = 100
                            // total = '1-9'
                        }

                        if (tempjudge >100 && tempjudge <= 300 ){

                            PCglobal.features[i].properties["Totalcases"] = 300

                        }

                        if (tempjudge > 300 && tempjudge <= 500 ){

                            PCglobal.features[i].properties["Totalcases"] = 500
                        }

                        if (tempjudge > 500 && tempjudge <= 800 ){

                            PCglobal.features[i].properties["Totalcases"] = 800
                        }

                        if (tempjudge > 800 && tempjudge <= 1500 ){

                            PCglobal.features[i].properties["Totalcases"] = 1500
                        }

                        if (tempjudge > 1500){

                            PCglobal.features[i].properties["Totalcases"] = 1600
                        }
                        if (tempjudge = 0) {
                            PCglobal.features[i].properties["Totalcases"] = 0
                        }

                        // PCglobal.features[i].properties["Uptodateselected"] = tempdateselected[j].CasesUptonow


                    }
                }
            }
            else {
                for (var j = 0; j < tempdataforclicknode.length; j++)
                {

                    if (PCglobal.features[i].properties.lgacode == tempdataforclicknode[j].LGAcode){
                        PCglobal.features[i].properties["interacteddate"] = tempdataforclicknode[j].Date;

                        var tempjudge = tempdataforclicknode[j].CasesUptonow;
                        // console.log(tempjudge);
                        PCglobal.features[i].properties["Realdata"] = tempjudge;
                        if(tempjudge <= 100 && tempjudge > 0){

                            PCglobal.features[i].properties["Totalcases"] = 100
                            // total = '1-9'
                        }

                        if (tempjudge >100 && tempjudge <= 300 ){

                            PCglobal.features[i].properties["Totalcases"] = 300

                        }

                        if (tempjudge > 300 && tempjudge <= 500 ){

                            PCglobal.features[i].properties["Totalcases"] = 500
                        }

                        if (tempjudge > 500 && tempjudge <= 800 ){

                            PCglobal.features[i].properties["Totalcases"] = 800
                        }

                        if (tempjudge > 800 && tempjudge <= 1500 ){

                            PCglobal.features[i].properties["Totalcases"] = 1500
                        }

                        if (tempjudge > 1500){

                            PCglobal.features[i].properties["Totalcases"] = 1600
                        }
                        if (tempjudge = 0) {
                            PCglobal.features[i].properties["Totalcases"] = 0
                        }
                        // PCglobal.features[i].properties["Uptodateselected"] = tempdateselected[j].CasesUptonow


                    }
                }
            }

        }
        //console.log(PCglobal);

        if (clickfilterflag == 0)
        {
            map.addSource('Nodeselected', {
                "type":"geojson",
                "data": PCglobal
            });
            //map.setPaintProperty('PostcodeCases','fill-color', "white");
            map.setPaintProperty('PostcodeCases','fill-opacity', 0.2);
            // if ((map.getSource('PostcodeselectedArea'))||((map.getSource('PostcodeCases'))))
            //     map.setPaintProperty('PostcodeselectedArea','fill-opacity', 0);
            // map.setPaintProperty('Postcodeselected','fill-opacity', 0);

            map.addLayer({
                "id": "NodeselectedArea",
                "type": "fill",
                "source": "Nodeselected",
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', "Totalcases"],
                        0, '#eeefef',
                        100,RedScale6redinmiddle[0],
                        300, RedScale6redinmiddle[1],
                        500, RedScale6redinmiddle[2],
                        800, RedScale6redinmiddle[3],
                        1500, RedScale6redinmiddle[4],
                        1600, RedScale6redinmiddle[5]

                    ],
                    'fill-opacity': 0.95
                }
            }, "Postcode");

            map.getSource('Postcode').setData(PCglobal);
            //map.getSource('NodeselectedArea').setData(PCglobal);
        }
        else{
            map.setPaintProperty('NodeselectedArea','fill-opacity', 0.95);
            map.getSource('Postcode').setData(PCglobal);
            //map.getSource('NodeselectedArea').setData(PCglobal);
            map.getSource('Nodeselected').setData(PCglobal);
        }
        clickfilterflag = 1;
        //console.log(PCglobal);
        //console.log(clickfilterflag);

        //console.log(dataarrayselected);
    }


    function Reset(){
        // if (sumupcases.length != 0){
        // dataarrayselected = []; //reset for next filtering

        //reset for parallel

        clickfilterflagForeachPetals = 0;
        for (var i = 0; i < parallelforinteraction.length; i++)
        {
            d3.select("#path-" + parallelforinteraction[i]["LGA_code"])
                .style("opacity", 0.9)
                .style("stroke-width",1.2);

        }

        // d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right').tickValues([]))

        d3.select('#paxis-name').call(axis.scale(y["LGA_Name"]).orient('right')
            .tickValues([]))

        //end reset for parallel
        nodeclickedflag4parallel = 0;
        parallelforstore = [];
        clickcircle0formap = [];
        dataarrayselected = [];
        datearrayselected = [];
        brushedtogetdata = [];
        brushtoclickdata = [];
        //tempmapdata0 = [];
        //console.log(dataarrayselected);
        var datestring=document.getElementById("demo");
        datestring.innerHTML=wholedate;

        exampleclickflag = 0;
        clickfilterflag = 0;
        clickfilterflagForeachPetals = 0;
        //reset for map
        Mapstoredata = [];
        // console.log(PCglobalforreset);
        // console.log(PCglobal);

        // PCglobal =  PCglobalforreset;

        //map.getSource('Postcode').setData(PCglobal);
        map.setPaintProperty('NodeselectedArea','fill-opacity', 0);
        map.setPaintProperty('Postcodeselected','line-color', GreyScale[0]);
        map.setPaintProperty('Postcodeselected',"line-width", 0.8);
        map.setPaintProperty('PostcodeCases','fill-opacity', 0.95);
        map.setPaintProperty('Circle0selected','line-color', GreyScale[0]);
        map.setPaintProperty('Circle0selected',"line-width", 0.8);


        // map.addSource('Nodeselected', {
        //     "type":"geojson",
        //     "data": PCglobal
        // });


        //console.log(map.getSource('Postcode'));

        for (var a = 0; a < examplepieclickflag.length; a++)
        {
            examplepieclickflag[a] = 0;
            d3.selectAll('#piebar-' + a)
                .style("stroke-width", 0)
                .style("opacity", 1)
                .style("stroke", "white");

            d3.select('#examplepiebar-' + a)
                .style("stroke-width", 0)
                .style("opacity", 1)
                .style("stroke", "white")
                .style(tocolor, function() {
                    //o = week - 1
                    //worse
                    if ((a == 12)||(a == 13)||(a == 14)||(a == 15)||(a == 16)||(a == 17)||(a == 18)||(a == 19)||(a == 20)||
                        (a == 21)||(a == 22)||(a == 23)||(a == 24)||(a == 25)||(a == 27)||(a == 42)||(a == 50)||(a == 51)||(a == 52))
                    {
                        return ColorGreyforExample[1]
                    }
                    //worst
                    if ((a == 28)||(a == 29)||(a == 30)||(a == 31)||(a == 32)||
                        (a == 33)||(a == 34)||(a == 35)||(a == 36)||(a == 37)||(a == 38)||(a == 39)||(a == 40)||(a == 41))
                    {
                        return ColorGreyforExample[2]
                    }
                    //normal
                    else{
                        return ColorGreyforExample[0];
                    }

                });


        }

        for (var c = 0 ; c < legendtempdata.length; c++)
        {
            //console.log(legendtempdata);

            d3.selectAll('#text-' + c)
                .attr("dy", "0.35em")
                .style("font-size", "5px")
                .style('opacity', 1);
            d3.select('#textranking-' + c)
                .text([]);

            //caution: circle0's id is the LGA code
            if (clickcircle0flag[c] == 1)
            {
                //console.log(d3.select('#circle0-'+ legendtempdata[c].id));
                d3.select('#circle0-'+ legendtempdata[c].id).style('fill','white').style("opacity", 1);
                clickcircle0flag[c] = 0;
            }
            //aiming reset all things on each chart


        }
        //console.log(clickcircle0flag);

        // } //RESOLVE BUG OF RESET ALL SELECTION, NOTE OF IF sumupcases.length != 0
        //console.log(sumupcases);
        sumupcases = [];
        ranksavingwordsafterselect = [];
        //savingweekdataafterselect = [];

        for (var i = 0; i < PCglobal.features.length; i++) {
            PCglobal.features[i].properties["Totalcases"] = 0;
            PCglobal.features[i].properties["Realdata"] = 0;
        }



    }

    //对元素对象进行排序,这里我采用的是快速排序
    function sortData(arr){
        if(!Array.isArray(arr))return;
        if(arr.length<=1) return arr;
        var mInd=Math.floor(arr.length/2)//中间索引
        var mVal=arr.splice(mInd,1)[0]//中间值
        var left= [],right=[];
        arr.forEach((el,ind)=>{
            if(Object.values(el)[0]>Object.values(mVal)[0]){
                left.push(el)
            }else{
                right.push(el)
            }
        })
        return sortData(left).concat(mVal,sortData(right))
    }

    //把索引值取出来组成一个新的数组即可
    function getSortedInd(arr){
        if(!Array.isArray(arr))return;
        var indArr=[]
        arr.forEach(el=>{
            indArr.push(Object.keys(el)[0])
        })
        return indArr
    }

    function sortRule(a,b) {
        return b.value - a.value;
    }


    function loadmap(PC, loadflag){

        //console.log(datearray);
        var startdatetemp = datearray[0];
        var enddatetemp = datearray[datearray.length-1];
        var startdate = startdatetemp.split("-");
        var enddate = enddatetemp.split("-");

        // var startrevisedateformat = startdate[0].slice(0,4) + "/" + startdate[0].slice(4,6) + "/" + startdate[0].slice(6,8);
        // var endrevisedateformat = enddate[1].slice(0,4) + "/" + enddate[1].slice(4,6) + "/" + enddate[1].slice(6,8);

        var startrevisedateformat = startdate[0];
        var endrevisedateformat = enddate[1];


        var finaldatestr = " " + startrevisedateformat + " - " + endrevisedateformat;

        wholedate = finaldatestr;

        wholedate = " 2020/01/01 - 2022/01/11";

        var datestring=document.getElementById("demo");
        datestring.innerHTML=finaldatestr;

        //var start;

        //console.log(PC);

        if (loadflag == 0){
            map.addSource('Postcode', {
                "type": "geojson",
                "data": PC
            })
            //console.log(Newmapdata);
            //console.log(PC);
            //console.log(dateSelected);
            map.addLayer({
                'id': 'Postcode',
                'source': 'Postcode',
                "type": 'line',
                "paint": {
                    "line-color": GreyScale[0],
                    "line-width": 0.8
                }
            })
            map.addLayer({
                'id': 'PostcodeCases',
                'source': 'Postcode',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', "Uptodateselected"],
                        0, '#eeefef',
                        // 5, "#d53e4f",
                        // 25, "#b8313e",
                        // 50, "#9c252f",
                        // 75, "#801820",
                        // 100, "#660b13",
                        // 1000, "#4d0000"
                        100,RedScale6redinmiddle[0],
                        300, RedScale6redinmiddle[1],
                        500, RedScale6redinmiddle[2],
                        800, RedScale6redinmiddle[3],
                        1500, RedScale6redinmiddle[4],
                        1600, RedScale6redinmiddle[5]

                    ],
                    'fill-opacity': 0.95
                }
            }, "Postcode")

            // },firstSymbolId)


            var homeBtnEl = '<button id="iconHome" type="button" title="Home">' +
                '<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="currentColor" class="bi bi-map-fill" viewBox="0 0 16 16">\n' +
                '  <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.598-.49L10.5.99 5.598.01a.5.5 0 0 0-.196 0l-5 1A.5.5 0 0 0 0 1.5v14a.5.5 0 0 0 .598.49l4.902-.98 4.902.98a.502.502 0 0 0 .196 0l5-1A.5.5 0 0 0 16 14.5V.5zM5 14.09V1.11l.5-.1.5.1v12.98l-.402-.08a.498.498 0 0 0-.196 0L5 14.09zm5 .8V1.91l.402.08a.5.5 0 0 0 .196 0L11 1.91v12.98l-.5.1-.5-.1z"/>\n' +
                '</svg></button>'
            $(homeBtnEl).appendTo('.mapboxgl-ctrl-top-right .mapboxgl-ctrl-group');
            var nswHomeBtn = document.getElementById('iconHome');

            nswHomeBtn.onclick = function(){
                //console.log(1)
                map.fitBounds(nswBounds);
                popup.remove();

            }

            // console.log(PC)

            map.getCanvas().style.cursor = ' '

            var popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: true
            });

            // console.log($('input[name="rtoggle"]:checked')[0].value == 'PostcodeCases')
        }


        map.on('mousemove', function (e) {
            var mousemovefeatures = map.queryRenderedFeatures(e.point);
            //console.log(mousemovefeatures[0].properties);
            if(mousemovefeatures[0].properties.lgacode)
            {

                //var Suburbs = []
                //console.log(mousemovefeatures[0].properties);
                //Suburbs = mousemovefeatures[0].properties.suburbName.split(",");

                // switch(Suburbs.length){
                //
                //     case 1:
                //         SuburbNames = firstUpperCase(Suburbs[0])
                //         break;
                //
                //     case 2:
                //         SuburbNames = firstUpperCase(Suburbs[0]) + ', ' + firstUpperCase(Suburbs[1])
                //         break;
                //
                //     default:
                //         SuburbNames = firstUpperCase(Suburbs[0]) + ', ' + firstUpperCase(Suburbs[1]) + ', ' + firstUpperCase(Suburbs[2])
                //
                // }

                map.getCanvas().style.cursor = 'pointer'

                var coordinates = [e.lngLat.lng, e.lngLat.lat];
                var totalNumber = dateSelected + 'Tot';

                var tempLGAname = mousemovefeatures[0].properties.LGAname;
                var tempLGAcode = mousemovefeatures[0].properties.LGAcode;
                if ((tempLGAname == undefined)||(tempLGAcode == undefined))
                {
                    tempLGAname = tempLGAcode = "Censored";
                }
                var description = "";

                //console.log(mousemovefeatures[0].properties);

                if (clickfilterflag == 0)
                {
                    description =
                        "LGA Name: " + tempLGAname
                        +  "<br>LGA Code: " + tempLGAcode
                        +  '<br>Total Cases in period: ' + mousemovefeatures[0].properties["Realdata"];
                }
                else{

                    description = "LGA Name: " + tempLGAname
                        +  "<br>LGA Code: " + tempLGAcode
                        +  '<br>Total Cases in this phase: ' + mousemovefeatures[0].properties["Realdata"];

                }

                //console.log(mousemovefeatures[0]);

                popup
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
            }

            else{
                map.getCanvas().style.cursor = ''
                popup.remove();
            }

        });


        map.on('click', function(e) {
            // map.removeLayer('Postcode');

            var mousemovefeatures = map.queryRenderedFeatures(e.point);
            //
            // if(mousemovefeatures[0].properties.POA_NAME16)
            // {
            //
            //     var Suburbs = []
            //     //console.log(mousemovefeatures[0]);
            //     Suburbs = mousemovefeatures[0].properties.suburbName.split(",");
            //
            //     switch(Suburbs.length){
            //
            //         case 1:
            //             SuburbNames = Suburbs[0]
            //             break;
            //
            //         case 2:
            //             SuburbNames = Suburbs[0] + ', ' + Suburbs[1]
            //             break;
            //
            //         default:
            //             SuburbNames = Suburbs[0] + ', ' + Suburbs[1] + ', ' + Suburbs[2]
            //
            //     }
            //
            //
            //     map.getCanvas().style.cursor = 'pointer'
            //
            //     var Number =  dateSelected
            //
            //     var TestNumber = dateSelected + 'tests'
            //     //
            //     var totalNumber = dateSelected + 'Tot'
            //
            //     var ActiveNumber = dateSelected + 'act'
            //
            //     var Recovered = dateSelected + 'rec'
            //
            //     var RecentTests = dateSelected + 'testsRecent'
            //
            //     var RecentTestsPerformed = mousemovefeatures[0].properties[RecentTests]
            //
            //     var testsPerformed = mousemovefeatures[0].properties[TestNumber]
            //
            //     var ActiveCases = mousemovefeatures[0].properties[ActiveNumber]
            //
            //     var TotalCases = mousemovefeatures[0].properties[totalNumber]
            //
            //     var range = mousemovefeatures[0].properties[totalNumber] ;
            //
            //     // var RecoveredNo = mousemovefeatures[0].properties[Recovered]
            //
            //     var coordinates = [e.lngLat.lng, e.lngLat.lat];
            //
            //     // var description1 =  '<br>Total Cases: ' + range + '<br> Active Cases<sup>**</sup>: ' + ActiveCases + '<br> Recovered Cases: ' + RecoveredNo + '<br> Total Tests: ' + testsPerformed + '<br> Recent Tests: ' + RecentTestsPerformed
            //     //
            //
            //     var description = 'Suburb: ' + SuburbNames + '<br> Postcode: ' + mousemovefeatures[0].properties.POA_NAME16
            //         +  "<br>LGA Name: " + mousemovefeatures[0].properties.LGAname
            //         +  "<br>LGA Code: " + mousemovefeatures[0].properties.LGAcode
            //         +  '<br>Total Cases: ' + range;
            //
            //     popup
            //         .setLngLat(coordinates)
            //         .setHTML(description)
            //         .addTo(map);
            // }
            //
            // else{
            //     map.getCanvas().style.cursor = ''
            //     popup.remove();
            // }

            //prepare to highlight on flower chart
            var clickedLGAcode = mousemovefeatures[0].properties.LGAcode;
            mapclickeddata.push(clickedLGAcode);
            //console.log(mapclickeddata);

            if (mapclickeddata.length > 0)
            {
                for (var i = 0; i < mapclickeddata.length; i ++)
                {
                    d3.select('#circle0-'+ mapclickeddata[i]).style('fill',GreyScale[0]).style("opacity", 1);
                    // d3.select(this).style('fill',ColorBrown[9]).style("fill-opacity", 0.75);
                    d3.select('#text-'+ mapclickeddata[i]).style("font-size", "7px");

                    for(var a = 0; a <legendtempdata.length; a++){
                        if (legendtempdata[a].id == mapclickeddata[i])
                        {
                            clickcircle0flag[legendtempdata[a].index] = 1;
                        }
                    }

                }
            }
            // console.log(legendtempdata);
            //
            // console.log(clickcircle0flag);




            //ends of highlight on flower chart


            if (clickfilterflag == 1)
            {
                map.setPaintProperty('PostcodeCases','fill-opacity', 0)
                map.setPaintProperty('NodeselectedArea','fill-opacity', 0.2);
            }
            else {
                map.setPaintProperty('PostcodeCases','fill-opacity', 0.2)
                map.setPaintProperty('NodeselectedArea','fill-opacity', 0);
            }


            var featurestemp = map.queryRenderedFeatures(e.point, { layers: ['PostcodeCases'] });
            if (!featurestemp.length) {
                return;
            }
            var featureclicked = featurestemp[0].toJSON();
            Mapstoredata.push(featureclicked.toJSON());
            //
            // console.log(featureclicked.toJSON());
            //console.log(Mapstoredata);
            var tempmapdata = {
                "features" : Mapstoredata,
                "type": "FeatureCollection"
            };
            //console.log(tempmapdata);

            //console.log(dateSelected);

            if (mapclickeddata.indexOf(mousemovefeatures[0].properties.LGAcode) != -1)
            {
                if (clickonmapflag == 0)
                {

                    //I think you could add the vector tile feature to the map, but I'm more familiar with JSON
                    //console.log(featureclicked.toJSON());


                    map.addSource('Postcodeselected', {
                        "type":"geojson",
                        "data": featureclicked
                    });
                    map.addLayer({
                        "id": "PostcodeselectedArea",
                        "type": "fill",
                        "source": "Postcodeselected",
                        'paint': {
                            'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', "Uptodateselected"],
                                0, '#eeefef',
                                // 5, "#d53e4f",
                                // 25, "#b8313e",
                                // 50, "#9c252f",
                                // 75, "#801820",
                                // 100, "#660b13",
                                // 1000, "#4d0000"
                                100,RedScale6redinmiddle[0],
                                300, RedScale6redinmiddle[1],
                                500, RedScale6redinmiddle[2],
                                800, RedScale6redinmiddle[3],
                                1500, RedScale6redinmiddle[4],
                                1600, RedScale6redinmiddle[5]

                            ],
                            'fill-opacity': 0.95
                        }
                    }, "Postcode");

                    map.addLayer({
                        "id": "Postcodeselected",
                        "type": "line",
                        "source": "Postcodeselected",

                        "paint": {
                            "line-color": GreyScale[1],
                            //"line-color": ColorBrown[9],
                            "line-width": 1.5
                        },
                        'fill-opacity': 1
                    });

                    clickonmapflag = 1;

                }
                else
                {

                    map.getSource('Postcodeselected').setData(tempmapdata);
                    // map.getSource('PostcodeselectedArea').setData(tempmapdata)
                    // clickonmapflag = 0;

                }
            }


        });

    }

    // Build the Big GeoJSON File.

    // function getMapdata(PC,pop,tests){
    function getMapdata(PC,pop,filterflag){

        datearray = unique(Mapdatafromstaweektable,'Date');
        //console.log(datearray);
        // console.log(Newmapdata.data);
        // console.log(Mapdatafromstaweektable);
        //console.log(datearray);
        // console.log(PC);

        // for (var a = 0; a < Newmapdata.data.length; a++)
        // {
        //     if (Newmapdata.data[a].POA_NAME16 == '2156')
        //     {
        //         console.log(Newmapdata.data[a]);
        //     }
        // }

        defaultDate = datearray[datearray.length - 1];
        //console.log(datearray);

        // defaultDateT = defaultDate + 'testRange';
        // defaultDateR = defaultDate + 'RecRange';
        // defaultDateTR = defaultDate + 'TRecRange'
        // defaultDateA = defaultDate + 'act'
        dateSelected = datearray[datearray.length- 1];
        // dateSelectedT = defaultDate + 'testRange';
        // dateSelectedR = defaultDate + 'RecRange';
        // dateSelectedTR = defaultDate + 'TRecRange';
        // dateSelectedA = dateSelected + 'act';

        // var tempsplit = [];
        // console.log(PC);
        // console.log(datearray);

        PC.features.forEach(function(v,i){

            // for (var d = 0; d < datearray.length; d++)
            // {
            //     tempsplit[d] = datearray[d].split('-');
            //
            // }
            //
            // console.log(tempsplit);

            datearray.forEach(function(a,j){

                // console.log(j);
                //console.log(a);

                var t = a + 'tests'
                var tr = a + 'testsRecent'
                var act = a + 'act'
                var tot = a + 'Tot'
                var rangeTests = a + 'testRange'
                var RecRange = a + 'RecRange'
                var TRecRange = a + 'TRecRange'
                var rec = a + 'rec'
                var cen = a + 'cen'

                // var dea = a + 'dea'

                v.properties[a] = 0
                v.properties[t] = 0
                v.properties[act] = 0
                v.properties[tot] = 0
                v.properties[rangeTests] = 0
                v.properties[rec] = 0
                v.properties[RecRange] = 0
                v.properties[TRecRange] = 0
                v.properties[tr] = 0
                v.properties[cen]= 0
                v.properties["Realdata"] = 0
                v.properties["Uptodateselected"] = 0
                v.properties["Totalcases"] = 0
                v.properties["interacteddate"] = ""

                // v.properties[dea] = 0

            })

            //var casesdata = getPostcodeData(Newmapdata.data,v.properties.POA_NAME16)
            var casesdata = getLGAData(Mapdatafromstaweektable,v.properties.lgacode)
            //console.log(casesdata);
            if(casesdata){
                var temptotalcases = 0;
                //console.log(casesdata);
                casesdata.forEach(function(x,j){

                    // console.log(x);
                    // console.log(v.properties);

                    var act = x.Date + 'act'
                    var tot = x.Date + 'Tot'
                    var rec = x.Date + 'rec'
                    var act1 = x.Date + 'RecRange'
                    var cen = x.Date + 'cen'

                    temptotalcases += parseInt(x.Cases);
                    var no = parseInt(x.Cases)
                    var to = parseInt(x.CasesUptonow)
                    // var recNo = parseInt(x.Recovered)
                    // var deaNo = parseInt(x.Deaths)
                    // var cenNo = parseInt(x.censored)

                    var th  = 0

                    var Recent = 0

                    var total = to

                    // var active = no - (recNo + deaNo + cenNo)
                    var active = no

                    if(to <= 100 && to > 0){
                        th = 100
                        // total = '1-9'
                    }

                    if (to > 100 && to <= 300 ){

                        th = 300

                    }

                    if (to > 300 && to <=500 ){

                        th = 500
                    }

                    if (to > 500 && to <=800 ){

                        th = 800
                    }

                    if (to > 800 && to <=1500 ){

                        th = 1500
                    }


                    if (to > 1500){

                        th = 1600
                    }

                    // if(active <= 5 && active > 0){
                    //
                    //     Recent = 5
                    //     // total = '1-9'
                    // }
                    //
                    // if (active >5 && active <= 25 ){
                    //
                    //     Recent = 25
                    //
                    // }
                    //
                    // if (active > 25 && active <= 50 ){
                    //
                    //     Recent = 50
                    // }
                    //
                    // if (active > 50 && active <= 75 ){
                    //
                    //     Recent = 75
                    // }
                    //
                    // if (active > 70 && active <= 100 ){
                    //
                    //     Recent = 100
                    // }
                    //
                    // if (active > 100){
                    //
                    //     Recent = 1000
                    // }


                    v.properties[x.Date] = th
                    v.properties[tot] = total
                    v.properties[act] = active
                    // v.properties[rec] = recNo
                    //v.properties[act1] = Recent
                    v.properties["LGAname"] = x.LGAname
                    v.properties["LGAcode"] = x.LGAcode
                    // v.properties["Uptodateselected"] = v.properties[dateSelected];

                    v.properties["Uptodateselected"] = to;
                    v.properties["Realdata"] = to;

                    //console.log(v.properties[dateSelected]);

                })

            }


            // var populationData = getPostcodeData(pop,v.properties.POA_NAME16)

            // if(populationData){
            //
            //     populationData.forEach(function(j,i){
            //
            //         //v.properties.population = j.Tot_p_p
            //         v.properties.suburbName = j.Combined
            //
            //     })
            // }

            //console.log(v);


        })
        //console.log(PC);

        PCglobal = PC;
        PCglobalforreset = PC;

        loadmap(PC , filterflag);
        //loadmap(PC , filterflag);
        // })

        // return full
    }
    function getLGAData(cases,lgacode){

        // console.log(lgacode)
        //
        // console.log(cases)

        var x = $.grep(cases,function(v,i){

            return v.LGAcode == lgacode
        })

        return x
    }

    // GEt Unique Date

    function unique(arr, prop) {
        return arr.map(function(e) { return e[prop]; }).filter(function(e,i,a){
            return i === a.indexOf(e);
        });
    }

    // Date firstUpperCase function

    function firstUpperCase(str) {
        return str.toLowerCase().replace(/\b[a-z]/g,function(s){return s.toUpperCase();});
    }

    Array.prototype.indexOf = function(val) {
        for (var i = 0; i < this.length; i++) {
            if (this[i] == val) return i;
        }
        return -1;
    };

    Array.prototype.remove = function(val) {
        var index = this.indexOf(val);
        if (index > -1) {
            this.splice(index, 1);
        }
    };

    function dropclick1(){
        var a = document.getElementById("dropdown-content").getElementsByTagName("a");
        console.log(a);
        document.getElementById("dropbtn").innerHTML = a[0].innerText;
    }

    function dropclick2(){
        var a = document.getElementById("dropdown-content").getElementsByTagName("a");
        console.log(a);
        document.getElementById("dropbtn").innerHTML = a[1].innerText;
    }

    function dropclick3(){
        var a = document.getElementById("dropdown-content2").getElementsByTagName("a");
        console.log(a);
        document.getElementById("dropbtn2").innerHTML = a[0].innerText;
        modestatus = '1';
        var pie = d3.layout.pie()
            //.data(allouterresults)
            // .sort(d3.descending)
            .sort(null)
            //默认降序排列，除非传入null
            .value(function(d) {
                //console.log(d);
                if (modestatus == '0')
                    return d.cases;
                else if (modestatus == '1')
                    return d.cases;
                else
                    return d.casespop;

            });
        var arc = d3.svg.arc()

            .startAngle(function(d) { return d.data.start * 2 * Math.PI/360;})
            .endAngle(function(d) { return d.data.end * 2 * Math.PI/360; })
            .innerRadius(29)
            .outerRadius(function (d) {
                //console.log(d);
                if( d.value > 0){
                    return 33 + outradius * (1.4 + Math.log(d.value+ 1) * 1.2);
                }
                else if (d.value == 1)
                {
                    return 30 + 3
                }
                else{
                    return 30 + 2;
                }
            })

            //外部高低
            .cornerRadius(50);

        d3.selectAll('g').selectAll(".node").each(function(temp) {
            // var pieflag = 0;
            //draw piesymbol
            d3.select('#node-' + temp.index).selectAll("#piebars").remove();

            piesymbol = d3.select('#node-' + temp.index).selectAll("#piebars")
            piesymbol.data(function(d, i) {
                console.log(d.proportions);
                return pie(d.proportions);
            })

                .enter()
                .append("g")
                .attr('id', 'piebars')

                .append("path")

                .attr("d", arc)
                .attr('id', function(d, o) {
                    //console.log(d);
                    //console.log(o);
                    return 'piebar-' + o;
                })

                .style(tocolor, function(d) {
                    //console.log(d);
                    if ( d.data.cases == 0)
                        return ColorGrey[0];
                    else
                        return Flowercolorpannel[0];
                })
                //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
                .style("stroke-width", nominal_stroke)

        })

    }

    function dropclick4(){
        var a = document.getElementById("dropdown-content2").getElementsByTagName("a");
        console.log(a);
        document.getElementById("dropbtn2").innerHTML = a[1].innerText;
        modestatus = '2';
        var pie = d3.layout.pie()
            //.data(allouterresults)
            // .sort(d3.descending)
            .sort(null)
            //默认降序排列，除非传入null
            .value(function(d) {
                //console.log(d);
                if (modestatus == '0')
                    return d.cases;
                else if (modestatus == '1')
                    return d.cases;
                else
                    return d.casespop;

            });
        var arc = d3.svg.arc()

            .startAngle(function(d) { return d.data.start * 2 * Math.PI/360;})
            .endAngle(function(d) { return d.data.end * 2 * Math.PI/360; })
            .innerRadius(29)
            .outerRadius(function (d) {
                //console.log(d);
                if( d.value > 0){
                    return 33 + outradius * (1.4 + Math.log(d.value+ 1) * 1.2);
                }
                else if (d.value == 1)
                {
                    return 30 + 3
                }
                else{
                    return 30 + 2;
                }
            })

            //外部高低
            .cornerRadius(50);

        d3.selectAll('g').selectAll(".node").each(function(temp) {
            // var pieflag = 0;
            //draw piesymbol

            //
            d3.select('#node-' + temp.index).selectAll("#piebars").remove();

            d3.select('#node-' + temp.index).selectAll("#piebars")
                .data(function(d, i) {
                    console.log(d.proportions);
                    return pie(d.proportions);
                })

                .enter()
                .append("g")
                .attr('id', 'piebars')

                .append("path")

                .attr("d", arc)
                .attr('id', function(d, o) {
                    //console.log(d);
                    //console.log(o);
                    return 'piebar-' + o;
                })

                .style(tocolor, function(d) {
                    //console.log(d);
                    if ( d.data.cases == 0)
                        return ColorGrey[0];
                    else
                        return Flowercolorpannel[0];
                })
                //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
                .style("stroke-width", nominal_stroke)

        })
    }


</script>

</body>
</html>

